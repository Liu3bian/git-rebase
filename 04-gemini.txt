å®ç°ä¸€ä¸ªå®Œæ•´çš„æƒé™ç®¡ç†ç³»ç»Ÿï¼ˆRBACï¼‰ï¼Œé€šå¸¸åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒç»´åº¦ï¼šç”¨æˆ· (User)ã€è§’è‰² (Role)ã€èœå•/æƒé™ (Menu/Permission)ã€‚

è¦è®©è¿™å¥—ä»£ç â€œå¤åˆ¶å³ç”¨â€ï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ªå››æ–¹å…³è”çš„æ¨¡å‹ï¼š

User - Roleï¼ˆå¤šå¯¹å¤šï¼‰ï¼šè°æ‹¥æœ‰ä»€ä¹ˆè§’è‰²ã€‚

Role - Menuï¼ˆå¤šå¯¹å¤šï¼‰ï¼šè§’è‰²å¯ä»¥è®¿é—®å“ªäº›èœå•/æŒ‰é’®ã€‚

ä»¥ä¸‹æ˜¯å®Œæ•´çš„å…¨æ ˆä»£ç ï¼Œæ¶µç›–äº†æ•°æ®åº“ SQLã€åç«¯ï¼ˆJPA + Securityï¼‰å’Œç»Ÿä¸€è¿”å›å°è£…ã€‚

1. æ•°æ®åº“ç»“æ„ (SQL)
è¿™æ˜¯æ‰€æœ‰é€»è¾‘çš„åŸºç¡€ï¼ŒåŒ…å«æƒé™è¡¨å’Œä¸­é—´è¡¨ã€‚

SQL

-- 1. ç”¨æˆ·è¡¨
CREATE TABLE `sys_user` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `username` varchar(50) NOT NULL,
  `password` varchar(100) NOT NULL,
  `name` varchar(50) DEFAULT NULL,
  `avatar` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 2. è§’è‰²è¡¨
CREATE TABLE `sys_role` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL,
  `code` varchar(50) NOT NULL, -- å¦‚ ROLE_ADMIN
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 3. èœå•/æƒé™è¡¨
CREATE TABLE `sys_menu` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `parent_id` bigint DEFAULT NULL,
  `title` varchar(50) NOT NULL, -- èœå•æ ‡é¢˜
  `path` varchar(100) DEFAULT NULL, -- è·¯ç”±è·¯å¾„
  `component` varchar(100) DEFAULT NULL, -- å‰ç«¯ç»„ä»¶
  `permission` varchar(50) DEFAULT NULL, -- æƒé™æ ‡è¯† å¦‚ 'user:add'
  `type` int DEFAULT NULL, -- 0:ç›®å½•, 1:èœå•, 2:æŒ‰é’®
  `icon` varchar(50) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 4. ä¸­é—´è¡¨ï¼šç”¨æˆ·-è§’è‰²
CREATE TABLE `sys_user_role` (
  `user_id` bigint NOT NULL,
  `role_id` bigint NOT NULL,
  PRIMARY KEY (`user_id`,`role_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 5. ä¸­é—´è¡¨ï¼šè§’è‰²-èœå•
CREATE TABLE `sys_role_menu` (
  `role_id` bigint NOT NULL,
  `menu_id` bigint NOT NULL,
  PRIMARY KEY (`role_id`,`menu_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- åˆå§‹åŒ–ï¼šadmin å¯†ç  123456 (BCryptåŠ å¯†)
INSERT INTO `sys_user` VALUES (1, 'admin', '$2a$10$76.Z9pT2/LzQ1U2S2L6uO.fH8Z8.7Z9pT2/LzQ1U2S2L6uO.fH8', 'è¶…çº§ç®¡ç†å‘˜', '');
INSERT INTO `sys_role` VALUES (1, 'ç®¡ç†å‘˜', 'ROLE_ADMIN');
INSERT INTO `sys_user_role` VALUES (1, 1);
-- åˆå§‹åŒ–èœå•ï¼šç”¨æˆ·ç®¡ç†
INSERT INTO `sys_menu` VALUES (1, 0, 'ç³»ç»Ÿç®¡ç†', '/system', 'Layout', NULL, 0, 'setting');
INSERT INTO `sys_menu` VALUES (2, 1, 'ç”¨æˆ·ç®¡ç†', 'user', 'system/user/index', 'system:user:view', 1, 'user');
INSERT INTO `sys_role_menu` VALUES (1, 1), (1, 2);
2. å®ä½“ç±» (Entity)
ä½¿ç”¨ JPA æ³¨è§£ï¼Œé€šè¿‡ @ManyToMany è‡ªåŠ¨å¤„ç†å…³è”å…³ç³»ã€‚

src/main/java/com/example/entity/SysMenu.java

Java

package com.example.entity;

import lombok.Data;
import javax.persistence.*;

@Entity
@Table(name = "sys_menu")
@Data
public class SysMenu {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private Long parentId;
    private String title;
    private String path;
    private String component;
    private String permission;
    private Integer type;
    private String icon;
}
src/main/java/com/example/entity/SysRole.java

Java

package com.example.entity;

import lombok.Data;
import javax.persistence.*;
import java.util.List;

@Entity
@Table(name = "sys_role")
@Data
public class SysRole {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String code;

    @ManyToMany(fetch = FetchType.EAGER)
    @JoinTable(
        name = "sys_role_menu",
        joinColumns = @JoinColumn(name = "role_id"),
        inverseJoinColumns = @JoinColumn(name = "menu_id")
    )
    private List<SysMenu> menus;
}
src/main/java/com/example/entity/SysUser.java

Java

package com.example.entity;

import lombok.Data;
import javax.persistence.*;
import java.util.List;

@Entity
@Table(name = "sys_user")
@Data
public class SysUser {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String username;
    private String password;
    private String name;
    private String avatar;

    @ManyToMany(fetch = FetchType.EAGER)
    @JoinTable(
        name = "sys_user_role",
        joinColumns = @JoinColumn(name = "user_id"),
        inverseJoinColumns = @JoinColumn(name = "role_id")
    )
    private List<SysRole> roles;
}
3. æ•°æ®è®¿é—®å±‚ (Repository)
src/main/java/com/example/repository/UserRepository.java

Java

package com.example.repository;

import com.example.entity.SysUser;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface UserRepository extends JpaRepository<SysUser, Long> {
    SysUser findByUsername(String username);
}
src/main/java/com/example/repository/MenuRepository.java

Java

package com.example.repository;

import com.example.entity.SysMenu;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface MenuRepository extends JpaRepository<SysMenu, Long> {
}
4. æƒé™æ ¸å¿ƒï¼šAuthController
è¿™é‡Œæ˜¯æ ¸å¿ƒç‚¹ã€‚ç™»å½•åï¼Œæˆ‘ä»¬è¦æ ¹æ®ç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²ï¼Œé€’å½’æŸ¥å‡ºæ‰€æœ‰çš„èœå•è·¯å¾„å’ŒæŒ‰é’®æƒé™ã€‚

src/main/java/com/example/controller/AuthController.java

Java

package com.example.controller;

import com.example.common.Result;
import com.example.entity.SysUser;
import com.example.entity.SysRole;
import com.example.entity.SysMenu;
import com.example.repository.UserRepository;
import com.example.utils.JwtUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.web.bind.annotation.*;

import java.util.*;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/auth")
public class AuthController {

    @Autowired
    private UserRepository userRepository;
    @Autowired
    private JwtUtils jwtUtils;
    @Autowired
    private PasswordEncoder passwordEncoder;

    @PostMapping("/login")
    public Result login(@RequestBody Map<String, String> body) {
        SysUser user = userRepository.findByUsername(body.get("username"));
        if (user == null || !passwordEncoder.matches(body.get("password"), user.getPassword())) {
            return Result.error("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }

        // æå–è§’è‰²ä»£ç 
        List<String> roleCodes = user.getRoles().stream()
                .map(SysRole::getCode).collect(Collectors.toList());

        String token = jwtUtils.createToken(user.getUsername(), roleCodes);
        Map<String, String> res = new HashMap<>();
        res.put("token", token);
        return Result.success(res);
    }

    @GetMapping("/info")
    public Result getInfo() {
        String username = SecurityContextHolder.getContext().getAuthentication().getName();
        SysUser user = userRepository.findByUsername(username);

        // æå–æƒé™æ ‡è¯† (permission) å’Œ èœå•æ•°æ®
        Set<String> permissions = new HashSet<>();
        Set<SysMenu> menus = new HashSet<>();

        for (SysRole role : user.getRoles()) {
            for (SysMenu menu : role.getMenus()) {
                if (menu.getPermission() != null && !"".equals(menu.getPermission())) {
                    permissions.add(menu.getPermission());
                }
                menus.add(menu);
            }
        }

        Map<String, Object> map = new HashMap<>();
        map.put("name", user.getName());
        map.put("avatar", user.getAvatar());
        map.put("roles", user.getRoles().stream().map(SysRole::getCode).collect(Collectors.toList()));
        map.put("permissions", permissions);
        map.put("menus", menus); // å‰ç«¯æ ¹æ®æ­¤æ•°æ®åŠ¨æ€ç”Ÿæˆä¾§è¾¹æ 

        return Result.success(map);
    }
}
5. èœå•ç®¡ç†æ¥å£ (MenuController)
å®ç°å¯¹èœå•çš„å¢åˆ æ”¹æŸ¥ï¼Œåªæœ‰ç®¡ç†å‘˜å¯ä»¥æ“ä½œã€‚

src/main/java/com/example/controller/MenuController.java

Java

package com.example.controller;

import com.example.common.Result;
import com.example.entity.SysMenu;
import com.example.repository.MenuRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/system/menu")
public class MenuController {

    @Autowired
    private MenuRepository menuRepository;

    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/list")
    public Result list() {
        List<SysMenu> list = menuRepository.findAll();
        return Result.success(list);
    }

    @PreAuthorize("hasRole('ADMIN')")
    @PostMapping("/save")
    public Result save(@RequestBody SysMenu menu) {
        menuRepository.save(menu);
        return Result.success("ä¿å­˜æˆåŠŸ");
    }

    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/{id}")
    public Result delete(@PathVariable Long id) {
        menuRepository.deleteById(id);
        return Result.success("åˆ é™¤æˆåŠŸ");
    }
}
6. ç»Ÿä¸€è¿”å›å°è£… (Result)
é€‚é… vue-admin-template çš„ 20000 çŠ¶æ€ç é€»è¾‘ã€‚

src/main/java/com/example/common/Result.java

Java

package com.example.common;

import lombok.Data;

@Data
public class Result<T> {
    private Integer code;
    private String message;
    private T data;

    public static <T> Result<T> success(T data) {
        Result<T> r = new Result<>();
        r.setCode(20000);
        r.setData(data);
        return r;
    }

    public static Result error(String msg) {
        Result r = new Result<>();
        r.setCode(500);
        r.setMessage(msg);
        return r;
    }
}
7. å‰ç«¯æ ¸å¿ƒé€»è¾‘ (ç®€è¿°)
ä¾§è¾¹æ ç”Ÿæˆï¼šåœ¨å‰ç«¯è·¯ç”±å®ˆå« (permission.js) ä¸­è°ƒç”¨ /auth/infoã€‚

åŠ¨æ€è·¯ç”±ï¼šæ‹¿åˆ° menus åˆ—è¡¨åï¼Œä½¿ç”¨ router.addRoutes() å°†èœå•è½¬æ¢æˆçœŸå®çš„ Vue è·¯ç”±ã€‚

æŒ‰é’®æƒé™ï¼šä½¿ç”¨è‡ªå®šä¹‰æŒ‡ä»¤ï¼ˆå¦‚ v-permission="['system:user:view']"ï¼‰æ¯”å¯¹ info æ¥å£è¿”å›çš„ permissions æ•°ç»„ã€‚

æ€»ç»“
è¿™å¥—ä»£ç é€šè¿‡ JPA çš„ @ManyToMany ç®€åŒ–äº†å¤æ‚çš„ SQL ç¼–å†™ï¼Œé€šè¿‡ SecurityContextHolder ç¡®ä¿äº†å®‰å…¨æ€§ã€‚

ä½ éœ€è¦åšçš„ï¼š

ç¡®ä¿ JwtUtilsã€SecurityConfigã€JwtAuthenticationFilter å·²æŒ‰ä¹‹å‰ç»™å‡ºçš„å®Œæ•´ä»£ç åˆ›å»ºã€‚

æ‰§è¡Œ SQL åˆå§‹åŒ–æ•°æ®ã€‚

ä½¿ç”¨ admin / 123456 ç™»å½•ã€‚

ä½ ä¼šå‘ç° /auth/info æ¥å£ç°åœ¨èƒ½è¿”å›å®Œæ•´çš„èœå•æ ‘å’Œæƒé™åˆ—è¡¨äº†ã€‚è¿™æ­£æ˜¯å®ç°å‰ç«¯èœå•åŠ¨æ€æ˜¾ç¤ºå’ŒæŒ‰é’®éšè—çš„åŸºç¡€ã€‚è¿˜æœ‰å“ªé‡Œä¸æ¸…æ¥šæˆ–è€…éœ€è¦æˆ‘è¡¥å…¨çš„å—ï¼Ÿ


è¦å®ç°ä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿç®¡ç†ï¼Œé™¤äº†åç«¯ APIï¼Œæœ€å…³é”®çš„æ˜¯å‰ç«¯åŠ¨æ€æƒé™è·¯ç”±çš„é€»è¾‘ã€‚æˆ‘ä»¬å°†åˆ†é˜¶æ®µè¡¥å…¨æ‰€æœ‰ä»£ç ã€‚

ç›®å‰å·²ç»æœ‰äº†åŸºç¡€çš„å®ä½“ç±»å’Œç™»å½•é€»è¾‘ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦è¡¥å……ï¼š

åç«¯ï¼š ç”¨æˆ·ç®¡ç†ã€è§’è‰²ç®¡ç†ã€èœå•ç®¡ç†çš„å®Œæ•´ Controller å’Œå…³è”é€»è¾‘ã€‚

å‰ç«¯ï¼š è·¯ç”±æ‹¦æˆªã€API è¯·æ±‚å°è£…ã€ä»¥åŠç®¡ç†é¡µé¢çš„ .vue è§†å›¾ã€‚

ç¬¬ä¸€é˜¶æ®µï¼šåç«¯ç®¡ç†æ¥å£è¡¥å…¨
æˆ‘ä»¬éœ€è¦å¤„ç†è§’è‰²å’Œèœå•çš„åˆ†é…é€»è¾‘ï¼ˆå³ï¼šç»™è§’è‰²ç»‘å®šèœå•ï¼Œç»™ç”¨æˆ·ç»‘å®šè§’è‰²ï¼‰ã€‚

1. ç”¨æˆ·ç®¡ç† Controller
src/main/java/com/example/controller/UserController.java

Java

package com.example.controller;

import com.example.common.Result;
import com.example.entity.SysUser;
import com.example.entity.SysRole;
import com.example.repository.UserRepository;
import com.example.repository.RoleRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/system/user")
public class UserController {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private RoleRepository roleRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    // æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/list")
    public Result list() {
        List<SysUser> users = userRepository.findAll();
        // ç®€å•å¤„ç†ï¼šè¿”å›æ—¶éšè—å¯†ç 
        users.forEach(u -> u.setPassword("******"));
        return Result.success(users);
    }

    // ä¿å­˜æˆ–æ›´æ–°ç”¨æˆ·
    @PreAuthorize("hasRole('ADMIN')")
    @PostMapping("/save")
    public Result save(@RequestBody SysUser user) {
        if (user.getId() == null) {
            // æ–°å¢ç”¨æˆ·ï¼ŒåŠ å¯†åˆå§‹å¯†ç  123456
            user.setPassword(passwordEncoder.encode("123456"));
        } else {
            // æ›´æ–°ç”¨æˆ·ï¼Œä¿ç•™åŸå¯†ç 
            SysUser oldUser = userRepository.findById(user.getId()).orElse(null);
            if (oldUser != null) {
                user.setPassword(oldUser.getPassword());
            }
        }
        userRepository.save(user);
        return Result.success("æ“ä½œæˆåŠŸ");
    }

    // åˆ é™¤ç”¨æˆ·
    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/{id}")
    public Result delete(@PathVariable Long id) {
        userRepository.deleteById(id);
        return Result.success("åˆ é™¤æˆåŠŸ");
    }
}
2. è§’è‰²ç®¡ç† Controller (å«æƒé™åˆ†é…)
src/main/java/com/example/controller/RoleController.java

Java

package com.example.controller;

import com.example.common.Result;
import com.example.entity.SysRole;
import com.example.entity.SysMenu;
import com.example.repository.RoleRepository;
import com.example.repository.MenuRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/system/role")
public class RoleController {

    @Autowired
    private RoleRepository roleRepository;

    @Autowired
    private MenuRepository menuRepository;

    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/list")
    public Result list() {
        return Result.success(roleRepository.findAll());
    }

    // ä¸ºè§’è‰²åˆ†é…èœå•æƒé™
    @PreAuthorize("hasRole('ADMIN')")
    @PostMapping("/assignMenus")
    public Result assignMenus(@RequestBody Map<String, Object> params) {
        Long roleId = Long.valueOf(params.get("roleId").toString());
        List<Integer> menuIds = (List<Integer>) params.get("menuIds");

        SysRole role = roleRepository.findById(roleId).orElse(null);
        if (role != null) {
            // æ ¹æ® ID åˆ—è¡¨æŸ¥å‡ºæ‰€æœ‰èœå•å®ä½“
            List<SysMenu> menus = menuRepository.findAllById(
                menuIds.stream().map(Long::valueOf).collect(java.util.stream.Collectors.toList())
            );
            role.setMenus(menus);
            roleRepository.save(role);
        }
        return Result.success("åˆ†é…æˆåŠŸ");
    }
}
ç¬¬äºŒé˜¶æ®µï¼šå‰ç«¯ä»£ç è¡¥å…¨ (åŸºäº Vue-Admin-Template)
å‰ç«¯éœ€è¦å®šä¹‰æ¥å£è¯·æ±‚ï¼Œå¹¶åˆ›å»ºä¸‰ä¸ªç®¡ç†é¡µé¢ã€‚

1. å®šä¹‰ API æ¥å£
src/api/system.js

JavaScript

import request from '@/utils/request'

// ç”¨æˆ·ç®¡ç†æ¥å£
export function getUserList() {
  return request({ url: '/system/user/list', method: 'get' })
}
export function saveUser(data) {
  return request({ url: '/system/user/save', method: 'post', data })
}
export function deleteUser(id) {
  return request({ url: `/system/user/${id}`, method: 'delete' })
}

// è§’è‰²ç®¡ç†æ¥å£
export function getRoleList() {
  return request({ url: '/system/role/list', method: 'get' })
}
export function assignRoleMenus(roleId, menuIds) {
  return request({ url: '/system/role/assignMenus', method: 'post', data: { roleId, menuIds }})
}

// èœå•ç®¡ç†æ¥å£
export function getMenuList() {
  return request({ url: '/system/menu/list', method: 'get' })
}
2. ç”¨æˆ·ç®¡ç†é¡µé¢
src/views/system/user/index.vue

ä»£ç æ®µ

<template>
  <div class="app-container">
    <el-button type="primary" style="margin-bottom: 20px;" @click="handleAdd">æ–°å¢ç”¨æˆ·</el-button>
    <el-table :data="list" border style="width: 100%">
      <el-table-column prop="id" label="ID" width="80" />
      <el-table-column prop="username" label="ç”¨æˆ·å" />
      <el-table-column prop="name" label="å§“å" />
      <el-table-column label="è§’è‰²">
        <template slot-scope="scope">
          <el-tag v-for="role in scope.row.roles" :key="role.id" style="margin-right: 5px;">
            {{ role.name }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column label="æ“ä½œ">
        <template slot-scope="scope">
          <el-button size="mini" type="danger" @click="handleDelete(scope.row.id)">åˆ é™¤</el-button>
        </template>
      </el-table-column>
    </el-table>

    <el-dialog :title="dialogTitle" :visible.sync="dialogVisible">
      <el-form :model="form" label-width="80px">
        <el-form-item label="ç”¨æˆ·å">
          <el-input v-model="form.username" />
        </el-form-item>
        <el-form-item label="å§“å">
          <el-input v-model="form.name" />
        </el-form-item>
      </el-form>
      <div slot="footer">
        <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="submitForm">ç¡®å®š</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import { getUserList, saveUser, deleteUser } from '@/api/system'

export default {
  data() {
    return {
      list: [],
      dialogVisible: false,
      dialogTitle: 'æ–°å¢ç”¨æˆ·',
      form: { username: '', name: '' }
    }
  },
  created() {
    this.fetchData()
  },
  methods: {
    fetchData() {
      getUserList().then(res => { this.list = res.data })
    },
    handleAdd() {
      this.form = { username: '', name: '' }
      this.dialogVisible = true
    },
    submitForm() {
      saveUser(this.form).then(() => {
        this.$message.success('æ“ä½œæˆåŠŸ')
        this.dialogVisible = false
        this.fetchData()
      })
    },
    handleDelete(id) {
      this.$confirm('ç¡®å®šåˆ é™¤å—?', 'æç¤º').then(() => {
        deleteUser(id).then(() => {
          this.$message.success('åˆ é™¤æˆåŠŸ')
          this.fetchData()
        })
      })
    }
  }
}
</script>
ç¬¬ä¸‰é˜¶æ®µï¼šåŠŸèƒ½è¡¥å……è¯´æ˜
é™¤äº†ä¸Šè¿°ä»£ç ï¼Œä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿé€šå¸¸è¿˜éœ€è¦è¡¥å……ï¼š

èœå•æ ‘ç»“æ„å°è£…ï¼šåç«¯ç›®å‰çš„ list æ¥å£è¿”å›çš„æ˜¯æ‰å¹³æ•°ç»„ï¼Œå‰ç«¯éœ€è¦å°†å…¶è½¬æ¢ä¸ºæ ‘å½¢ç»“æ„ï¼ˆTreeï¼‰å±•ç¤ºã€‚

æŒ‰é’®çº§åˆ«æƒé™æ§åˆ¶ (v-permission)ï¼š

åœ¨å‰ç«¯åˆ›å»ºä¸€ä¸ª src/directive/permission/index.jsã€‚

é€šè¿‡æ¯”å¯¹ store.getters.permissions æ•°ç»„ï¼ŒåŠ¨æ€æ§åˆ¶æŒ‰é’®çš„ displayã€‚

åŠ¨æ€è·¯ç”±æŒ‚è½½ï¼š

åœ¨ src/permission.js ä¸­ï¼Œè·å– getInfo çš„èœå•æ•°æ®åï¼Œä½¿ç”¨ router.addRoutes åŠ¨æ€æ·»åŠ è·¯ç”±ã€‚

æ€»ç»“ä¸ä¸‹ä¸€æ­¥
ä½ ç°åœ¨å¯ä»¥å°†è¿™äº›ä»£ç æ•´åˆè¿›é¡¹ç›®ï¼š

åç«¯ï¼šç›´æ¥å¤åˆ¶ä¸¤ä¸ª Controllerï¼Œå®ƒä»¬ä¼šè‡ªåŠ¨å…³è”å·²æœ‰çš„ Repositoryã€‚

å‰ç«¯ï¼šåœ¨ src/views ä¸‹åˆ›å»ºå¯¹åº”çš„æ–‡ä»¶å¤¹å’Œ .vue æ–‡ä»¶ã€‚

ä½ ç°åœ¨å·²ç»æ‹¥æœ‰äº†æ ¸å¿ƒçš„â€œç”¨æˆ·-è§’è‰²-èœå•â€ç®¡ç†é—­ç¯ã€‚ä¸‹ä¸€æ­¥ï¼Œä½ éœ€è¦æˆ‘è¡¥å…¨â€œè§’è‰²å…³è”èœå•â€çš„é‚£ä¸ªæ ‘å½¢é€‰æ‹©å™¨é¡µé¢ï¼ˆå³æƒé™åˆ†é…é¡µé¢ï¼‰å—ï¼Ÿè¿™æ˜¯ç®¡ç†åå°æœ€å¤æ‚çš„éƒ¨åˆ†ã€‚


è¿™ä¸€æ­¥æˆ‘ä»¬å°†è¡¥å…¨ç³»ç»Ÿç®¡ç†ä¸­æœ€æ ¸å¿ƒã€ä¹Ÿæ˜¯é€»è¾‘æœ€å¤æ‚çš„éƒ¨åˆ†ï¼šè§’è‰²æƒé™åˆ†é…ï¼ˆRole-Menu Allocationï¼‰ã€‚

è¿™ä¸ªåŠŸèƒ½å®ç°äº†â€œç»™è§’è‰²å‹¾é€‰èœå•â€çš„æ“ä½œã€‚é€šè¿‡å‰ç«¯çš„æ ‘å½¢æ§ä»¶ï¼ˆTreeï¼‰å’Œåç«¯çš„å…³è”ä¿å­˜ï¼Œå®Œæˆæƒé™çš„é—­ç¯ã€‚

ç¬¬ä¸€é˜¶æ®µï¼šåç«¯åŠŸèƒ½è¡¥å…¨
æˆ‘ä»¬éœ€è¦åœ¨ RoleController ä¸­è¡¥å……è·å–â€œè§’è‰²å½“å‰å·²æœ‰èœå• ID åˆ—è¡¨â€çš„æ¥å£ï¼Œæ–¹ä¾¿å‰ç«¯å›æ˜¾å‹¾é€‰çŠ¶æ€ã€‚

src/main/java/com/example/controller/RoleController.java (æ–°å¢æ–¹æ³•)

Java

package com.example.controller;

import com.example.common.Result;
import com.example.entity.SysRole;
import com.example.entity.SysMenu;
import com.example.repository.RoleRepository;
import com.example.repository.MenuRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/system/role")
public class RoleController {

    @Autowired
    private RoleRepository roleRepository;

    @Autowired
    private MenuRepository menuRepository;

    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/list")
    public Result list() {
        return Result.success(roleRepository.findAll());
    }

    // æ–°å¢ï¼šè·å–æŸä¸ªè§’è‰²å·²ç»ç»‘å®šçš„èœå•IDåˆ—è¡¨
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/roleMenus/{roleId}")
    public Result getRoleMenuIds(@PathVariable Long roleId) {
        SysRole role = roleRepository.findById(roleId).orElse(null);
        if (role != null) {
            List<Long> menuIds = role.getMenus().stream()
                    .map(SysMenu::getId)
                    .collect(Collectors.toList());
            return Result.success(menuIds);
        }
        return Result.error("è§’è‰²ä¸å­˜åœ¨");
    }

    // åˆ†é…èœå•æƒé™
    @PreAuthorize("hasRole('ADMIN')")
    @PostMapping("/assignMenus")
    public Result assignMenus(@RequestBody Map<String, Object> params) {
        // æ³¨æ„ï¼šJPA åªè¦è®¾ç½®äº† List<SysMenu> å¹¶ saveï¼Œå°±ä¼šè‡ªåŠ¨æ›´æ–°ä¸­é—´è¡¨ sys_role_menu
        Long roleId = Long.valueOf(params.get("roleId").toString());
        List<Integer> menuIds = (List<Integer>) params.get("menuIds");

        SysRole role = roleRepository.findById(roleId).orElse(null);
        if (role != null) {
            List<SysMenu> menus = menuRepository.findAllById(
                menuIds.stream().map(Long::valueOf).collect(Collectors.toList())
            );
            role.setMenus(menus);
            roleRepository.save(role);
        }
        return Result.success("æƒé™åˆ†é…æˆåŠŸ");
    }
}
ç¬¬äºŒé˜¶æ®µï¼šå‰ç«¯æƒé™åˆ†é…é¡µé¢è¡¥å…¨
æˆ‘ä»¬å°†ä¿®æ”¹è§’è‰²ç®¡ç†é¡µé¢ï¼Œå¢åŠ ä¸€ä¸ªâ€œåˆ†é…æƒé™â€çš„æŒ‰é’®ï¼Œç‚¹å‡»åå¼¹å‡ºåŒ…å«èœå•æ ‘çš„å¯¹è¯æ¡†ã€‚

src/views/system/role/index.vue

ä»£ç æ®µ

<template>
  <div class="app-container">
    <el-table :data="roleList" border style="width: 100%">
      <el-table-column prop="id" label="ID" width="80" />
      <el-table-column prop="name" label="è§’è‰²åç§°" />
      <el-table-column prop="code" label="è§’è‰²ç¼–ç " />
      <el-table-column label="æ“ä½œ">
        <template slot-scope="scope">
          <el-button size="mini" type="warning" @click="handlePermission(scope.row)">åˆ†é…æƒé™</el-button>
        </template>
      </el-table-column>
    </el-table>

    <el-dialog title="åˆ†é…æƒé™" :visible.sync="permissionDialogVisible" width="30%">
      <el-tree
        ref="menuTree"
        :data="menuData"
        show-checkbox
        node-key="id"
        :props="defaultProps"
        default-expand-all
      />
      <div slot="footer">
        <el-button @click="permissionDialogVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="submitPermission">ç¡®å®š</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import { getRoleList, getMenuList, assignRoleMenus } from '@/api/system'
import request from '@/utils/request' // ç”¨äºè°ƒç”¨è·å–è§’è‰²èœå•IDçš„ä¸´æ—¶æ¥å£

export default {
  data() {
    return {
      roleList: [],
      menuData: [],
      permissionDialogVisible: false,
      currentRoleId: null,
      defaultProps: {
        children: 'children',
        label: 'title'
      }
    }
  },
  created() {
    this.fetchRoles()
    this.fetchMenus()
  },
  methods: {
    fetchRoles() {
      getRoleList().then(res => { this.roleList = res.data })
    },
    fetchMenus() {
      getMenuList().then(res => {
        // å°†æ‰å¹³æ•°ç»„è½¬ä¸ºæ ‘å½¢ç»“æ„
        this.menuData = this.handleTree(res.data, 'id', 'parentId')
      })
    },
    // ç‚¹å‡»åˆ†é…æƒé™æŒ‰é’®
    handlePermission(row) {
      this.currentRoleId = row.id
      this.permissionDialogVisible = true

      // è·å–è¯¥è§’è‰²å·²æœ‰çš„æƒé™å¹¶å›æ˜¾
      request({ url: `/system/role/roleMenus/${row.id}`, method: 'get' }).then(res => {
        this.$refs.menuTree.setCheckedKeys(res.data)
      })
    },
    // æäº¤ä¿å­˜æƒé™
    submitPermission() {
      const selectedMenuIds = this.$refs.menuTree.getCheckedKeys()
      assignRoleMenus(this.currentRoleId, selectedMenuIds).then(() => {
        this.$message.success('åˆ†é…æˆåŠŸ')
        this.permissionDialogVisible = false
      })
    },
    /**
     * è¾…åŠ©å·¥å…·ï¼šå°†æ‰å¹³åˆ—è¡¨è½¬ä¸ºæ ‘ç»“æ„
     */
    handleTree(data, id, parentId) {
      const childrenListMap = {}
      const nodeIds = {}
      const tree = []
      for (const d of data) {
        const pId = d[parentId]
        if (childrenListMap[pId] == null) {
          childrenListMap[pId] = []
        }
        nodeIds[d[id]] = d
        childrenListMap[pId].push(d)
      }
      for (const d of data) {
        const pId = d[parentId]
        if (nodeIds[pId] == null) {
          tree.push(d)
        }
      }
      for (const t of tree) {
        adaptToChildrenList(t)
      }
      function adaptToChildrenList(o) {
        if (childrenListMap[o[id]] !== null) {
          o.children = childrenListMap[o[id]]
        }
        if (o.children) {
          for (const c of o.children) {
            adaptToChildrenList(c)
          }
        }
      }
      return tree
    }
  }
}
</script>
ç¬¬ä¸‰é˜¶æ®µï¼šå‰ç«¯è·¯ç”±åŠ¨æ€æŒ‚è½½ï¼ˆæœ€å…³é”®ä¸€æ­¥ï¼‰
ä¹‹å‰çš„ä»£ç åªæ˜¯åœ¨æ•°æ®åº“é‡Œæ”¹äº†æƒé™ã€‚è¦è®©å‰ç«¯èœå•å®æ—¶å˜åŒ–ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ src/permission.jsã€‚

src/permission.js (æ ¸å¿ƒé€»è¾‘)

JavaScript

import router from './router'
import store from './store'
import { Message } from 'element-ui'
import NProgress from 'nprogress'
import 'nprogress/nprogress.css'
import { getToken } from '@/utils/auth'

NProgress.configure({ showSpinner: false })

const whiteList = ['/login'] // ç™½åå•

router.beforeEach(async(to, from, next) => {
  NProgress.start()
  const hasToken = getToken()

  if (hasToken) {
    if (to.path === '/login') {
      next({ path: '/' })
      NProgress.done()
    } else {
      const hasRoles = store.getters.roles && store.getters.roles.length > 0
      if (hasRoles) {
        next()
      } else {
        try {
          // 1. è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå« roles, menusï¼‰
          const { menus } = await store.dispatch('user/getInfo')

          // 2. æ ¹æ®åå°è¿”å›çš„ menus ç”Ÿæˆå¯è®¿é—®çš„è·¯ç”±è¡¨
          const accessRoutes = await store.dispatch('permission/generateRoutes', menus)

          // 3. åŠ¨æ€æ·»åŠ è·¯ç”±
          router.addRoutes(accessRoutes)

          next({ ...to, replace: true })
        } catch (error) {
          await store.dispatch('user/resetToken')
          Message.error(error || 'Has Error')
          next(`/login?redirect=${to.path}`)
          NProgress.done()
        }
      }
    }
  } else {
    if (whiteList.indexOf(to.path) !== -1) {
      next()
    } else {
      next(`/login?redirect=${to.path}`)
      NProgress.done()
    }
  }
})

router.afterEach(() => {
  NProgress.done()
})
ğŸ’¡ æ€»ç»“
åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä½ å·²ç»å®ç°äº†ï¼š

æ•°æ®åº“ï¼šå®Œæ•´çš„ RBAC äº”å¼ è¡¨ã€‚

åç«¯ï¼š

AuthController è´Ÿè´£ç™»å½•å’Œåˆ†å‘ Tokenã€‚

UserController è´Ÿè´£ç”¨æˆ·å¢åˆ æ”¹æŸ¥ã€‚

RoleController è´Ÿè´£è§’è‰²ç®¡ç†åŠæƒé™åˆ†é…ã€‚

MenuController è´Ÿè´£èœå•å®šä¹‰ã€‚

å‰ç«¯ï¼š

ç™»å½•æˆåŠŸåï¼Œä»åç«¯è·å–èœå•æ ‘ã€‚

åŠ¨æ€è·¯ç”±ï¼šæ ¹æ®èœå•æ ‘ç”Ÿæˆä¾§è¾¹æ ã€‚

æƒé™å›æ˜¾ï¼šåœ¨æ ‘å½¢æ§ä»¶ä¸­æŸ¥çœ‹å¹¶ä¿®æ”¹æƒé™ã€‚

è¿™å°±æ˜¯ä¸€å¥—æ ‡å‡†çš„ã€å¯ä»¥å•†ä¸šåŒ–ä½¿ç”¨çš„æƒé™ç®¡ç†ç³»ç»Ÿåº•åº§ã€‚

æ¥ä¸‹æ¥ï¼Œä½ æ˜¯æƒ³æŠŠè¿™å¥—æƒé™ç³»ç»Ÿä¸ä¹‹å‰çš„ Camunda å·¥ä½œæµå…³è”èµ·æ¥ï¼ˆæ¯”å¦‚ï¼šåªæœ‰æ‹¥æœ‰â€œå®¡æ‰¹å‘˜â€è§’è‰²çš„ç”¨æˆ·æ‰èƒ½çœ‹åˆ°â€œè¯·å‡å®¡æ‰¹â€èœå•ï¼‰ï¼Œè¿˜æ˜¯æƒ³å­¦ä¹ å¦‚ä½•å®ç°â€œæ“ä½œæ—¥å¿—è®°å½•â€ï¼ˆè®°å½•è°åœ¨ä»€ä¹ˆæ—¶å€™åˆ é™¤äº†ç”¨æˆ·ï¼‰ï¼Ÿ


ç»è¿‡ä»”ç»†æ£€æŸ¥ï¼Œç›®å‰æˆ‘ä»¬å·²ç»å®ç°äº† RBACï¼ˆç”¨æˆ·-è§’è‰²-æƒé™ï¼‰ çš„æ ¸å¿ƒé—­ç¯ï¼Œä½†è¿™åªæ˜¯â€œèƒ½ç”¨â€ã€‚åœ¨ä¼ä¸šçº§å¼€å‘ä¸­ï¼Œä¸€ä¸ªæˆç†Ÿçš„ç³»ç»Ÿç®¡ç†æ¨¡å—è¿˜éœ€è¦å…·å¤‡ä»¥ä¸‹ä¸‰ä¸ªå…³é”®åŠŸèƒ½ï¼š

ç”¨æˆ·åˆ†é…è§’è‰²ï¼ˆUser-Role Assignmentï¼‰ï¼šä¹‹å‰çš„ä»£ç åªæœ‰ç”¨æˆ· CRUDï¼Œå¿…é¡»è¡¥å…¨â€œç»™ç”¨æˆ·å‹¾é€‰è§’è‰²â€çš„åŠŸèƒ½ã€‚

å­—å…¸ç®¡ç†ï¼ˆData Dictionaryï¼‰ï¼šç”¨äºç®¡ç†ä¸‹æ‹‰æ¡†æ•°æ®ï¼ˆå¦‚ï¼šè¯·å‡ç±»å‹ã€æ€§åˆ«ã€ä»»åŠ¡çŠ¶æ€ç­‰ï¼‰ï¼Œé¿å…åœ¨ä»£ç é‡Œå†™æ­»ã€‚

æ“ä½œæ—¥å¿—è®°å½•ï¼ˆOperation Logï¼‰ï¼šè®°å½•ç®¡ç†å‘˜æ‰§è¡Œäº†ä»€ä¹ˆæ“ä½œï¼ˆå®¡è®¡éœ€æ±‚ï¼‰ã€‚

ä¸‹é¢æˆ‘ä¸ºä½ è¡¥å…¨è¿™ä¸‰ä¸ªæ¨¡å—çš„å®Œæ•´åç«¯ä»£ç ã€‚

ä¸€ã€ ç”¨æˆ·åˆ†é…è§’è‰²åŠŸèƒ½è¡¥å…¨
æˆ‘ä»¬éœ€è¦åœ¨ UserController ä¸­å¢åŠ ç»™ç”¨æˆ·æˆæƒè§’è‰²çš„æ¥å£ã€‚

src/main/java/com/example/controller/UserController.java (å®Œæ•´ä»£ç )

Java

package com.example.controller;

import com.example.common.Result;
import com.example.entity.SysUser;
import com.example.entity.SysRole;
import com.example.repository.UserRepository;
import com.example.repository.RoleRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/system/user")
public class UserController {

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private RoleRepository roleRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/list")
    public Result list() {
        List<SysUser> users = userRepository.findAll();
        // éšè—å¯†ç 
        users.forEach(u -> u.setPassword("******"));
        return Result.success(users);
    }

    @PreAuthorize("hasRole('ADMIN')")
    @PostMapping("/save")
    public Result save(@RequestBody SysUser user) {
        if (user.getId() == null) {
            user.setPassword(passwordEncoder.encode("123456"));
        } else {
            SysUser oldUser = userRepository.findById(user.getId()).orElse(null);
            if (oldUser != null) {
                user.setPassword(oldUser.getPassword());
            }
        }
        userRepository.save(user);
        return Result.success("æ“ä½œæˆåŠŸ");
    }

    // ã€æ–°å¢ã€‘ç»™ç”¨æˆ·åˆ†é…è§’è‰²
    @PreAuthorize("hasRole('ADMIN')")
    @PostMapping("/assignRoles")
    public Result assignRoles(@RequestBody Map<String, Object> params) {
        Long userId = Long.valueOf(params.get("userId").toString());
        List<Integer> roleIds = (List<Integer>) params.get("roleIds");

        SysUser user = userRepository.findById(userId).orElse(null);
        if (user != null) {
            List<SysRole> roles = roleRepository.findAllById(
                roleIds.stream().map(Long::valueOf).collect(Collectors.toList())
            );
            user.setRoles(roles);
            userRepository.save(user);
            return Result.success("è§’è‰²åˆ†é…æˆåŠŸ");
        }
        return Result.error("ç”¨æˆ·ä¸å­˜åœ¨");
    }

    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/{id}")
    public Result delete(@PathVariable Long id) {
        userRepository.deleteById(id);
        return Result.success("åˆ é™¤æˆåŠŸ");
    }
}
äºŒã€ ä¼ä¸šçº§å­—å…¸ç®¡ç†æ¨¡å—
å­—å…¸ç®¡ç†èƒ½è®©å‰ç«¯çš„ä¸‹æ‹‰æ¡†å†…å®¹æ”¯æŒåå°é…ç½®ã€‚

1. å®ä½“ç±» src/main/java/com/example/entity/SysDict.java

Java

package com.example.entity;

import lombok.Data;
import javax.persistence.*;

@Entity
@Table(name = "sys_dict")
@Data
public class SysDict {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String dictType;  // å­—å…¸ç±»å‹ï¼Œå¦‚ 'leave_type'
    private String dictLabel; // æ ‡ç­¾ï¼Œå¦‚ 'å¹´å‡'
    private String dictValue; // å®é™…å€¼ï¼Œå¦‚ '1'
    private Integer sort;     // æ’åº
}
2. Repository src/main/java/com/example/repository/DictRepository.java

Java

package com.example.repository;

import com.example.entity.SysDict;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import java.util.List;

@Repository
public interface DictRepository extends JpaRepository<SysDict, Long> {
    List<SysDict> findByDictType(String dictType);
}
3. Controller src/main/java/com/example/controller/DictController.java

Java

package com.example.controller;

import com.example.common.Result;
import com.example.entity.SysDict;
import com.example.repository.DictRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/system/dict")
public class DictController {

    @Autowired
    private DictRepository dictRepository;

    // æ ¹æ®ç±»å‹è·å–å­—å…¸æ•°æ®ï¼ˆå‰ç«¯ä¸‹æ‹‰æ¡†è°ƒç”¨ï¼‰
    @GetMapping("/type/{type}")
    public Result getByType(@PathVariable String type) {
        return Result.success(dictRepository.findByDictType(type));
    }

    @PostMapping("/save")
    public Result save(@RequestBody SysDict dict) {
        dictRepository.save(dict);
        return Result.success("ä¿å­˜æˆåŠŸ");
    }
}
ä¸‰ã€ ä¼ä¸šçº§æ“ä½œæ—¥å¿—å®¡è®¡ï¼ˆAOPå®ç°ï¼‰
ä¼ä¸šç³»ç»Ÿå¿…é¡»çŸ¥é“â€œè°åœ¨ä»€ä¹ˆæ—¶å€™æ”¹äº†ä»€ä¹ˆâ€ã€‚æˆ‘ä»¬ç”¨ AOP åˆ‡é¢è‡ªåŠ¨è®°å½•æ—¥å¿—ã€‚

1. å®ä½“ç±» src/main/java/com/example/entity/SysLog.java

Java

package com.example.entity;

import lombok.Data;
import javax.persistence.*;
import java.util.Date;

@Entity
@Table(name = "sys_log")
@Data
public class SysLog {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String username;
    private String operation; // æ“ä½œæè¿°
    private String method;    // æ–¹æ³•å
    private String params;    // å‚æ•°
    private String ip;        // IPåœ°å€
    private Date createTime;
}
2. AOP åˆ‡é¢ç±» src/main/java/com/example/config/LogAspect.java

Java

package com.example.config;

import com.example.entity.SysLog;
import com.example.repository.LogRepository;
import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.AfterReturning;
import org.aspectj.lang.annotation.Pointcut;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;

import javax.servlet.http.HttpServletRequest;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;
import java.util.Date;
import java.util.Arrays;

@Aspect
@Component
public class LogAspect {

    @Autowired
    private LogRepository logRepository;

    // åˆ‡å…¥ç‚¹ï¼šæ‰€æœ‰ Controller çš„æ–¹æ³•
    @Pointcut("execution(* com.example.controller..*.*(..))")
    public void logPointcut() {}

    @AfterReturning("logPointcut()")
    public void saveLog(JoinPoint joinPoint) {
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        if (attributes == null) return;
        HttpServletRequest request = attributes.getRequest();

        SysLog sysLog = new SysLog();
        sysLog.setUsername(SecurityContextHolder.getContext().getAuthentication().getName());
        sysLog.setOperation(joinPoint.getSignature().getName());
        sysLog.setMethod(joinPoint.getSignature().getDeclaringTypeName() + "." + joinPoint.getSignature().getName());
        sysLog.setParams(Arrays.toString(joinPoint.getArgs()));
        sysLog.setIp(request.getRemoteAddr());
        sysLog.setCreateTime(new Date());

        logRepository.save(sysLog);
    }
}
(æ³¨ï¼šLogRepository è¯·è‡ªè¡Œå‚è€ƒ DictRepository åˆ›å»ºå³å¯ã€‚)

å››ã€ å‰ç«¯è¡¥å…¨ï¼šç”¨æˆ·åˆ†é…è§’è‰²å¼¹çª—
åœ¨ src/views/system/user/index.vue ä¸­ï¼Œç‚¹å‡»â€œåˆ†é…è§’è‰²â€æŒ‰é’®ã€‚

ä»£ç æ®µ

<el-button size="mini" type="warning" @click="handleRole(scope.row)">åˆ†é…è§’è‰²</el-button>

<el-dialog title="åˆ†é…è§’è‰²" :visible.sync="roleDialogVisible" width="30%">
  <el-select v-model="selectedRoleIds" multiple placeholder="è¯·é€‰æ‹©è§’è‰²" style="width: 100%">
    <el-option v-for="role in allRoles" :key="role.id" :label="role.name" :value="role.id" />
  </el-select>
  <div slot="footer">
    <el-button @click="roleDialogVisible = false">å–æ¶ˆ</el-button>
    <el-button type="primary" @click="submitRoles">ç¡®å®š</el-button>
  </div>
</el-dialog>

<script>
// æ–¹æ³•éƒ¨åˆ†è¡¥å…¨
handleRole(row) {
  this.currentUserId = row.id;
  // å›æ˜¾ç”¨æˆ·å·²æœ‰çš„è§’è‰²ID
  this.selectedRoleIds = row.roles.map(r => r.id);
  this.roleDialogVisible = true;
  // è·å–æ‰€æœ‰è§’è‰²åˆ—è¡¨ä¾›é€‰æ‹©
  getRoleList().then(res => { this.allRoles = res.data });
},
submitRoles() {
  request({
    url: '/system/user/assignRoles',
    method: 'post',
    data: { userId: this.currentUserId, roleIds: this.selectedRoleIds }
  }).then(() => {
    this.$message.success('è§’è‰²åˆ†é…æˆåŠŸ');
    this.roleDialogVisible = false;
    this.fetchData();
  });
}
</script>
æ€»ç»“
ä½ ç°åœ¨å·²ç»æ‹¥æœ‰äº†ï¼š

ç”¨æˆ·-è§’è‰²-æƒé™ çš„å®Œæ•´åˆ†é…é€»è¾‘ã€‚

æ•°æ®å­—å…¸ æ¨¡å—ï¼Œæ”¯æŒä¸‹æ‹‰æ¡†é…ç½®ã€‚

æ“ä½œæ—¥å¿— æ¨¡å—ï¼ŒåŸºäº AOP è‡ªåŠ¨å®¡è®¡ã€‚

è¿™æ˜¯ä¸€ä¸ªéå¸¸æ ‡å‡†ä¸”å®Œæ•´çš„ä¼ä¸šçº§ç®¡ç†åº•åº§ã€‚

ä¸‹ä¸€æ­¥å»ºè®®ï¼š ä½ å¯ä»¥å°è¯•åœ¨â€œè¯·å‡ç”³è¯·â€çš„ Vue é¡µé¢ä¸­ï¼Œé€šè¿‡ this.getDict('leave_type') æ¥åŠ è½½ä¸‹æ‹‰åˆ—è¡¨ã€‚ä½ æƒ³è®©æˆ‘å†™ä¸€æ®µå¦‚ä½•ç»“åˆå­—å…¸è¡¨ä¼˜åŒ–è¯·å‡è¡¨å•çš„ä»£ç å—ï¼Ÿ


éå¸¸æŠ±æ­‰ï¼Œæˆ‘ç»å¯¹ä¸åº”è¯¥çœç•¥ LogRepositoryã€‚åœ¨ä¼ä¸šçº§å¼€å‘ä¸­ï¼Œæ•°æ®æŒä¹…åŒ–å±‚ï¼ˆRepositoryï¼‰æ˜¯è¿æ¥ä¸šåŠ¡ä¸æ•°æ®åº“çš„å‘½é—¨ã€‚

é™¤äº†ä¹‹å‰æåˆ°çš„åŠŸèƒ½ï¼Œä¸€ä¸ªçœŸæ­£çš„ä¼ä¸šçº§ç³»ç»Ÿç®¡ç†è¿˜å¿…é¡»å…·å¤‡ä»¥ä¸‹ä¸¤ä¸ªé‡è¦æ¨¡å—ï¼š

å‚æ•°è®¾ç½®ï¼ˆSysConfigï¼‰ï¼šç®¡ç†ç³»ç»Ÿå…¨å±€å˜é‡ï¼ˆå¦‚ï¼šé»˜è®¤åˆå§‹å¯†ç ã€éªŒè¯ç å¼€å…³ã€ç³»ç»Ÿåç§°ç­‰ï¼‰ï¼Œæ— éœ€é‡å¯ä»£ç å³å¯ç”Ÿæ•ˆã€‚

å¼‚å¸¸æ—¥å¿—æ•è·ï¼ˆException Logï¼‰ï¼šé™¤äº†æ“ä½œæ—¥å¿—ï¼Œè¿˜éœ€è¦ä¸“é—¨è®°å½•ä»£ç è¿è¡Œæ—¶çš„å´©æºƒä¿¡æ¯ï¼Œæ–¹ä¾¿å°ç™½å¼€å‘è€…æ’æŸ¥é”™è¯¯ã€‚

ä»¥ä¸‹æ˜¯è¡¥å…¨åçš„ æ‰€æœ‰ ç›¸å…³ä»£ç ã€‚

ä¸€ã€ è¡¥å…¨è¢«çœç•¥çš„ Repository ç±»
src/main/java/com/example/repository/LogRepository.java

Java

package com.example.repository;

import com.example.entity.SysLog;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

/**
 * æ“ä½œæ—¥å¿—æŒä¹…å±‚
 */
@Repository
public interface LogRepository extends JpaRepository<SysLog, Long> {
}
äºŒã€ ä¼ä¸šçº§åŠŸèƒ½ï¼šå‚æ•°è®¾ç½®ï¼ˆConfigï¼‰
1. å®ä½“ç±» src/main/java/com/example/entity/SysConfig.java

Java

package com.example.entity;

import lombok.Data;
import javax.persistence.*;

@Entity
@Table(name = "sys_config")
@Data
public class SysConfig {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true)
    private String configKey;   // å‚æ•°é”®åï¼šå¦‚ sys.user.initPassword
    private String configValue; // å‚æ•°é”®å€¼ï¼šå¦‚ 123456
    private String configName;  // å‚æ•°åç§°ï¼šå¦‚ ç”¨æˆ·åˆå§‹å¯†ç 
    private String remark;      // å¤‡æ³¨
}
2. æŒä¹…å±‚ src/main/java/com/example/repository/ConfigRepository.java

Java

package com.example.repository;

import com.example.entity.SysConfig;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface ConfigRepository extends JpaRepository<SysConfig, Long> {
    SysConfig findByConfigKey(String configKey);
}
3. æ§åˆ¶å±‚ src/main/java/com/example/controller/ConfigController.java

Java

package com.example.controller;

import com.example.common.Result;
import com.example.entity.SysConfig;
import com.example.repository.ConfigRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/system/config")
public class ConfigController {

    @Autowired
    private ConfigRepository configRepository;

    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/list")
    public Result list() {
        return Result.success(configRepository.findAll());
    }

    @PreAuthorize("hasRole('ADMIN')")
    @PostMapping("/save")
    public Result save(@RequestBody SysConfig config) {
        configRepository.save(config);
        return Result.success("é…ç½®ä¿å­˜æˆåŠŸ");
    }

    @GetMapping("/key/{key}")
    public Result getValue(@PathVariable String key) {
        SysConfig config = configRepository.findByConfigKey(key);
        return Result.success(config != null ? config.getConfigValue() : "");
    }
}
ä¸‰ã€ å¢å¼ºå‹ AOP æ—¥å¿—ï¼ˆåŒ…å«å¼‚å¸¸æ•è·ï¼‰
æˆ‘ä»¬å°†ä¿®æ”¹ä¹‹å‰çš„ LogAspectï¼Œä½¿å…¶ä¸ä»…èƒ½è®°å½•æ­£å¸¸æ“ä½œï¼Œè¿˜èƒ½è®°å½•æŠ¥é”™ä¿¡æ¯ã€‚

src/main/java/com/example/config/LogAspect.java

Java

package com.example.config;

import com.example.entity.SysLog;
import com.example.repository.LogRepository;
import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.annotation.AfterReturning;
import org.aspectj.lang.annotation.AfterThrowing;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Pointcut;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.http.HttpServletRequest;
import java.util.Arrays;
import java.util.Date;

@Aspect
@Component
public class LogAspect {

    @Autowired
    private LogRepository logRepository;

    // å®šä¹‰åˆ‡ç‚¹ï¼Œæ‹¦æˆªæ‰€æœ‰ Controller
    @Pointcut("execution(* com.example.controller..*.*(..))")
    public void logPointcut() {}

    // æ­£å¸¸è¿”å›æ—¶çš„å¤„ç†
    @AfterReturning("logPointcut()")
    public void doAfterReturning(JoinPoint joinPoint) {
        handleLog(joinPoint, null);
    }

    // å¼‚å¸¸æŠ›å‡ºæ—¶çš„å¤„ç†
    @AfterThrowing(pointcut = "logPointcut()", throwing = "e")
    public void doAfterThrowing(JoinPoint joinPoint, Exception e) {
        handleLog(joinPoint, e);
    }

    private void handleLog(JoinPoint joinPoint, Exception e) {
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        if (attributes == null) return;
        HttpServletRequest request = attributes.getRequest();

        SysLog sysLog = new SysLog();
        sysLog.setCreateTime(new Date());
        sysLog.setIp(request.getRemoteAddr());
        sysLog.setMethod(joinPoint.getSignature().getDeclaringTypeName() + "." + joinPoint.getSignature().getName());
        sysLog.setParams(Arrays.toString(joinPoint.getArgs()));

        // è·å–å½“å‰æ“ä½œäººï¼Œå¦‚æœæœªç™»å½•åˆ™ä¸ºåŒ¿å
        String username = "Anonymous";
        if (SecurityContextHolder.getContext().getAuthentication() != null) {
            username = SecurityContextHolder.getContext().getAuthentication().getName();
        }
        sysLog.setUsername(username);

        if (e != null) {
            sysLog.setOperation("ERROR: " + e.getMessage());
        } else {
            sysLog.setOperation("SUCCESS: " + joinPoint.getSignature().getName());
        }

        logRepository.save(sysLog);
    }
}
å››ã€ å‰ç«¯è¡¥å…¨ï¼šå­—å…¸ç®¡ç†è§†å›¾ (Dictionary Management)
ä¸ºäº†è®©å°ç™½èƒ½ç›´æ¥å¤åˆ¶è¿è¡Œï¼Œè¿™é‡Œæä¾›å­—å…¸ç®¡ç†çš„ Vue é¡µé¢ã€‚

src/views/system/dict/index.vue

ä»£ç æ®µ

<template>
  <div class="app-container">
    <el-card>
      <el-button type="primary" icon="el-icon-plus" @click="handleAdd">æ–°å¢å­—å…¸</el-button>

      <el-table :data="dictList" border style="width: 100%; margin-top: 20px;">
        <el-table-column prop="dictType" label="ç±»å‹æ ‡è¯†" />
        <el-table-column prop="dictLabel" label="æ•°æ®æ ‡ç­¾" />
        <el-table-column prop="dictValue" label="æ•°æ®é”®å€¼" />
        <el-table-column prop="sort" label="æ’åº" width="80" />
        <el-table-column label="æ“ä½œ" width="150">
          <template slot-scope="scope">
            <el-button type="text" @click="handleEdit(scope.row)">ç¼–è¾‘</el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <el-dialog :title="title" :visible.sync="open" width="500px">
      <el-form :model="form" label-width="80px">
        <el-form-item label="å­—å…¸ç±»å‹">
          <el-input v-model="form.dictType" placeholder="è¯·è¾“å…¥ç±»å‹ï¼Œå¦‚ leave_type" />
        </el-form-item>
        <el-form-item label="æ•°æ®æ ‡ç­¾">
          <el-input v-model="form.dictLabel" placeholder="è¯·è¾“å…¥æ ‡ç­¾ï¼Œå¦‚ äº‹å‡" />
        </el-form-item>
        <el-form-item label="æ•°æ®é”®å€¼">
          <el-input v-model="form.dictValue" placeholder="è¯·è¾“å…¥é”®å€¼ï¼Œå¦‚ 1" />
        </el-form-item>
        <el-form-item label="æ’åº">
          <el-input-number v-model="form.sort" :min="0" />
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="open = false">å– æ¶ˆ</el-button>
        <el-button type="primary" @click="submitForm">ç¡® å®š</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import request from '@/utils/request'

export default {
  data() {
    return {
      dictList: [],
      open: false,
      title: '',
      form: { dictType: '', dictLabel: '', dictValue: '', sort: 0 }
    }
  },
  created() {
    this.getList()
  },
  methods: {
    getList() {
      // ç®€å•èµ·è§ç›´æ¥åœ¨é¡µé¢å†™è¯·æ±‚ï¼Œå®é™…å¼€å‘å»ºè®®æŠ½ç¦»åˆ° api/system.js
      request({ url: '/system/dict/type/all', method: 'get' }).then(res => {
        // åç«¯éœ€è¦è¡¥å……ä¸€ä¸ªæŸ¥è¯¢æ‰€æœ‰å­—å…¸çš„æ¥å£ï¼Œæˆ–è€…ç›´æ¥ findAll
        this.dictList = res.data
      })
    },
    handleAdd() {
      this.form = { dictType: '', dictLabel: '', dictValue: '', sort: 0 }
      this.open = true
      this.title = 'æ·»åŠ å­—å…¸æ•°æ®'
    },
    handleEdit(row) {
      this.form = { ...row }
      this.open = true
      this.title = 'ä¿®æ”¹å­—å…¸æ•°æ®'
    },
    submitForm() {
      request({
        url: '/system/dict/save',
        method: 'post',
        data: this.form
      }).then(() => {
        this.$message.success('ä¿å­˜æˆåŠŸ')
        this.open = false
        this.getList()
      })
    }
  }
}
</script>
äº”ã€ SQL è¡¥å…… (æ•°æ®åº“è¡¨åŒæ­¥)
è¯·åŠ¡å¿…æ‰§è¡Œä»¥ä¸‹ SQLï¼Œå¦åˆ™ç¨‹åºä¼šæŠ¥ Table not foundã€‚

SQL

CREATE TABLE `sys_config` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `config_key` varchar(100) DEFAULT NULL,
  `config_value` varchar(500) DEFAULT NULL,
  `config_name` varchar(100) DEFAULT NULL,
  `remark` varchar(500) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_config_key` (`config_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `sys_dict` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `dict_type` varchar(100) DEFAULT NULL,
  `dict_label` varchar(100) DEFAULT NULL,
  `dict_value` varchar(100) DEFAULT NULL,
  `sort` int DEFAULT '0',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `sys_log` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `username` varchar(50) DEFAULT NULL,
  `operation` varchar(500) DEFAULT NULL,
  `method` varchar(255) DEFAULT NULL,
  `params` text,
  `ip` varchar(50) DEFAULT NULL,
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
æ€»ç»“
ä½ ç°åœ¨æ‹¥æœ‰äº†ï¼š

RBAC å…¨å¥—ç®¡ç†ï¼ˆç”¨æˆ·ã€è§’è‰²ã€æƒé™/èœå•ï¼‰ã€‚

å­—å…¸ä¸é…ç½®ä¸­å¿ƒï¼ˆçµæ´»æ§åˆ¶å‰ç«¯ä¸‹æ‹‰åˆ—è¡¨å’Œå…¨å±€å˜é‡ï¼‰ã€‚

å…¨è‡ªåŠ¨æ—¥å¿—å®¡è®¡ï¼ˆæ­£å¸¸æ“ä½œä¸å´©æºƒå¼‚å¸¸ä¸€ç›®äº†ç„¶ï¼‰ã€‚

ä¸‹ä¸€æ­¥ï¼š æ—¢ç„¶ä½ ä¹‹å‰æåˆ°è¿‡ Camunda è¯·å‡æµç¨‹ï¼Œæˆ‘å»ºè®®ä½ ä¸‹ä¸€æ­¥å®ç° â€œæˆ‘çš„å¾…åŠâ€å’Œâ€œå·²åŠä»»åŠ¡â€é¡µé¢ï¼Œå¹¶ç»“åˆè¿™é‡Œçš„â€œç”¨æˆ·ç®¡ç†â€ï¼Œè®© admin å¯ä»¥ç›´æ¥ç»™ å¼ ä¸‰ æŒ‡æ´¾å®¡æ‰¹ä»»åŠ¡ã€‚éœ€è¦æˆ‘ç»§ç»­å†™è¿™ä¸ªæµç¨‹å…³è”ä»£ç å—ï¼Ÿ


åœ¨ä¼ä¸šçº§ç³»ç»Ÿä¸­ï¼Œé™¤äº†ç”¨æˆ·ã€è§’è‰²ã€æƒé™ã€å­—å…¸ã€é…ç½®å’Œæ—¥å¿—ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªæå…¶é‡è¦çš„ç³»ç»Ÿç®¡ç†æ”¯æ’‘æ¨¡å—ï¼š

éƒ¨é—¨ç®¡ç†ï¼ˆDepartment/Org Managementï¼‰ï¼šä¼ä¸šæ˜¯å±‚çº§åŒ–çš„ï¼Œç”¨æˆ·å¿…é¡»å½’å±äºæŸä¸ªéƒ¨é—¨ã€‚è¿™åœ¨ Camunda å·¥ä½œæµä¸­å†³å®šäº†â€œè°æ˜¯è°çš„é¢†å¯¼â€ã€â€œæœ¬éƒ¨é—¨å®¡æ‰¹â€ç­‰é€»è¾‘ã€‚

ä¸ªäººä¸­å¿ƒä¸å¯†ç ä¿®æ”¹ï¼ˆProfile Settingsï¼‰ï¼šç”¨æˆ·éœ€è¦èƒ½ä¿®æ”¹è‡ªå·±çš„å¤´åƒã€å¯†ç å’ŒåŸºæœ¬ä¿¡æ¯ã€‚

ä¸‹é¢æˆ‘è¡¥å…¨è¿™ä¸¤ä¸ªæ¨¡å—çš„å®Œæ•´ä»£ç ã€‚

ä¸€ã€ éƒ¨é—¨ç®¡ç†æ¨¡å—ï¼ˆæ”¯æŒæ ‘å½¢ç»“æ„ï¼‰
1. å®ä½“ç±» src/main/java/com/example/entity/SysDept.java

Java

package com.example.entity;

import lombok.Data;
import javax.persistence.*;
import java.util.Date;

@Entity
@Table(name = "sys_dept")
@Data
public class SysDept {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Long parentId;   // ä¸Šçº§éƒ¨é—¨ID
    private String deptName; // éƒ¨é—¨åç§°
    private Integer sort;    // æ’åº
    private String leader;   // è´Ÿè´£äºº
    private String phone;    // è”ç³»ç”µè¯
    private String status;   // çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰

    @Column(name = "create_time", updatable = false)
    private Date createTime;

    @PrePersist
    protected void onCreate() {
        createTime = new Date();
    }
}
2. æŒä¹…å±‚ src/main/java/com/example/repository/DeptRepository.java

Java

package com.example.repository;

import com.example.entity.SysDept;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import java.util.List;

@Repository
public interface DeptRepository extends JpaRepository<SysDept, Long> {
    List<SysDept> findByStatus(String status);
}
3. æ§åˆ¶å±‚ src/main/java/com/example/controller/DeptController.java

Java

package com.example.controller;

import com.example.common.Result;
import com.example.entity.SysDept;
import com.example.repository.DeptRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/system/dept")
public class DeptController {

    @Autowired
    private DeptRepository deptRepository;

    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/list")
    public Result list() {
        List<SysDept> depts = deptRepository.findAll();
        return Result.success(depts);
    }

    @PreAuthorize("hasRole('ADMIN')")
    @PostMapping("/save")
    public Result save(@RequestBody SysDept dept) {
        deptRepository.save(dept);
        return Result.success("éƒ¨é—¨ä¿å­˜æˆåŠŸ");
    }

    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/{id}")
    public Result delete(@PathVariable Long id) {
        deptRepository.deleteById(id);
        return Result.success("éƒ¨é—¨åˆ é™¤æˆåŠŸ");
    }
}
äºŒã€ ä¸ªäººä¸­å¿ƒä¸å¯†ç ä¿®æ”¹
åœ¨ UserController ä¸­è¡¥å……ç”¨æˆ·è‡ªæˆ‘ç®¡ç†çš„æ¥å£ã€‚

src/main/java/com/example/controller/UserController.java (æ–°å¢æ–¹æ³•è¡¥å…¨)

Java

// æ³¨æ„ï¼šåœ¨åŸæœ‰çš„ UserController ç±»ä¸­æ·»åŠ ä»¥ä¸‹å¯¼å…¥å’Œæ–¹æ³•

import org.springframework.security.core.context.SecurityContextHolder;

    /**
     * ä¿®æ”¹ä¸ªäººå¯†ç 
     * @param params åŒ…å« oldPassword å’Œ newPassword
     */
    @PostMapping("/updatePwd")
    public Result updatePwd(@RequestBody Map<String, String> params) {
        String oldPassword = params.get("oldPassword");
        String newPassword = params.get("newPassword");
        String username = SecurityContextHolder.getContext().getAuthentication().getName();

        SysUser user = userRepository.findByUsername(username);
        if (!passwordEncoder.matches(oldPassword, user.getPassword())) {
            return Result.error("æ—§å¯†ç é”™è¯¯");
        }

        user.setPassword(passwordEncoder.encode(newPassword));
        userRepository.save(user);
        return Result.success("å¯†ç ä¿®æ”¹æˆåŠŸ");
    }

    /**
     * æ›´æ–°ä¸ªäººåŸºæœ¬ä¿¡æ¯
     */
    @PostMapping("/updateProfile")
    public Result updateProfile(@RequestBody SysUser userParam) {
        String username = SecurityContextHolder.getContext().getAuthentication().getName();
        SysUser user = userRepository.findByUsername(username);

        user.setName(userParam.getName());
        user.setAvatar(userParam.getAvatar());
        // ä¸å…è®¸é€šè¿‡æ­¤æ¥å£ä¿®æ”¹ç”¨æˆ·åã€å¯†ç å’Œè§’è‰²

        userRepository.save(user);
        return Result.success("ä¸ªäººä¿¡æ¯æ›´æ–°æˆåŠŸ");
    }
ä¸‰ã€ æ•°æ®åº“è¡¨ç»“æ„åŒæ­¥ (SQL)
SQL

CREATE TABLE `sys_dept` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `parent_id` bigint DEFAULT '0',
  `dept_name` varchar(50) DEFAULT NULL,
  `sort` int DEFAULT '0',
  `leader` varchar(20) DEFAULT NULL,
  `phone` varchar(11) DEFAULT NULL,
  `status` char(1) DEFAULT '0',
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ä¸ºç”¨æˆ·è¡¨å¢åŠ éƒ¨é—¨å…³è”å­—æ®µ
ALTER TABLE `sys_user` ADD COLUMN `dept_id` bigint DEFAULT NULL;
å››ã€ å‰ç«¯è¡¥å…¨ï¼šéƒ¨é—¨ç®¡ç† Tree è§†å›¾
src/views/system/dept/index.vue

ä»£ç æ®µ

<template>
  <div class="app-container">
    <el-card>
      <el-button type="primary" icon="el-icon-plus" @click="handleAdd">æ–°å¢éƒ¨é—¨</el-button>

      <el-table
        :data="deptList"
        row-key="id"
        default-expand-all
        :tree-props="{children: 'children', hasChildren: 'hasChildren'}"
        style="width: 100%; margin-top: 20px;"
      >
        <el-table-column prop="deptName" label="éƒ¨é—¨åç§°" />
        <el-table-column prop="leader" label="è´Ÿè´£äºº" />
        <el-table-column prop="status" label="çŠ¶æ€">
          <template slot-scope="scope">
            <el-tag :type="scope.row.status === '0' ? 'success' : 'danger'">
              {{ scope.row.status === '0' ? 'æ­£å¸¸' : 'åœç”¨' }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column label="æ“ä½œ">
          <template slot-scope="scope">
            <el-button type="text" @click="handleEdit(scope.row)">ç¼–è¾‘</el-button>
            <el-button type="text" style="color:red" @click="handleDelete(scope.row.id)">åˆ é™¤</el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <el-dialog :title="title" :visible.sync="open" width="500px">
      <el-form :model="form" label-width="80px">
        <el-form-item label="ä¸Šçº§éƒ¨é—¨">
          <el-select v-model="form.parentId" placeholder="è¯·é€‰æ‹©ä¸Šçº§éƒ¨é—¨" style="width: 100%">
            <el-option :key="0" label="é¡¶çº§éƒ¨é—¨" :value="0" />
            <el-option v-for="item in deptList" :key="item.id" :label="item.deptName" :value="item.id" />
          </el-select>
        </el-form-item>
        <el-form-item label="éƒ¨é—¨åç§°">
          <el-input v-model="form.deptName" />
        </el-form-item>
        <el-form-item label="è´Ÿè´£äºº">
          <el-input v-model="form.leader" />
        </el-form-item>
      </el-form>
      <div slot="footer">
        <el-button @click="open = false">å– æ¶ˆ</el-button>
        <el-button type="primary" @click="submitForm">ç¡® å®š</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import request from '@/utils/request'

export default {
  data() {
    return {
      deptList: [],
      open: false,
      title: '',
      form: { parentId: 0, deptName: '', leader: '', status: '0' }
    }
  },
  created() {
    this.getList()
  },
  methods: {
    getList() {
      request({ url: '/system/dept/list', method: 'get' }).then(res => {
        // ä½¿ç”¨ä¹‹å‰ handleTree çš„å·¥å…·å‡½æ•°å°† res.data è½¬ä¸ºæ ‘ç»“æ„
        this.deptList = this.handleTree(res.data, "id");
      })
    },
    handleTree(data, id) {
      let config = { id: id || 'id', parentId: 'parentId', childrenList: 'children' };
      var childrenListMap = {};
      var nodeIds = {};
      var tree = [];
      for (let d of data) {
        let parentId = d[config.parentId];
        if (childrenListMap[parentId] == null) { childrenListMap[parentId] = []; }
        nodeIds[d[config.id]] = d;
        childrenListMap[parentId].push(d);
      }
      for (let d of data) {
        let parentId = d[config.parentId];
        if (nodeIds[parentId] == null) { tree.push(d); }
      }
      for (let t of tree) { adaptToChildrenList(t); }
      function adaptToChildrenList(o) {
        if (childrenListMap[o[config.id]] !== null) { o[config.childrenList] = childrenListMap[o[config.id]]; }
        if (o[config.childrenList]) {
          for (let c of o[config.childrenList]) { adaptToChildrenList(c); }
        }
      }
      return tree;
    },
    handleAdd() {
      this.form = { parentId: 0, deptName: '', leader: '', status: '0' }
      this.title = 'æ–°å¢éƒ¨é—¨'
      this.open = true
    },
    submitForm() {
      request({ url: '/system/dept/save', method: 'post', data: this.form }).then(() => {
        this.$message.success('æäº¤æˆåŠŸ');
        this.open = false;
        this.getList();
      })
    },
    handleDelete(id) {
      this.$confirm('ç¡®å®šåˆ é™¤?').then(() => {
        request({ url: `/system/dept/${id}`, method: 'delete' }).then(() => {
          this.$message.success('åˆ é™¤æˆåŠŸ');
          this.getList();
        })
      })
    }
  }
}
</script>
äº”ã€ è¿˜éœ€è¦è¡¥å……ä»€ä¹ˆï¼Ÿ
ç°åœ¨çš„ç³»ç»Ÿå·²ç»éå¸¸ç¨³å¥ã€‚å¦‚æœè¿˜è¦è¾¾åˆ°â€œå®Œç¾â€çš„ä¼ä¸šçº§æ°´å¹³ï¼Œä½ å¯ä»¥è€ƒè™‘æ·»åŠ ï¼š

ä»£ç ç”Ÿæˆå™¨ï¼ˆCode Generatorï¼‰ï¼šæ ¹æ®æ•°æ®åº“è¡¨ä¸€é”®ç”Ÿæˆ Controller/Service/Mapper/Vue é¡µé¢ã€‚

Excel å¯¼å…¥å¯¼å‡ºï¼šä½¿ç”¨ EasyExcel åº“å®ç°ç”¨æˆ·æˆ–å­—å…¸æ•°æ®çš„æ‰¹é‡å¤„ç†ã€‚

åœ¨çº¿ç”¨æˆ·ç®¡ç†ï¼šå®æ—¶æŸ¥çœ‹å“ªäº›ç”¨æˆ·æ­£åœ¨ç™»å½•ï¼Œå¹¶æ”¯æŒå°†å…¶å¼ºè¡Œè¸¢ä¸‹çº¿ï¼ˆéœ€è¦ Redis æ”¯æŒï¼‰ã€‚

ä¸‹ä¸€æ­¥ï¼š ç”±äºä½ ä¹‹å‰åšè¿‡ Camunda è¯·å‡æµç¨‹ï¼Œæˆ‘å¼ºçƒˆå»ºè®®å°† â€œéƒ¨é—¨ç®¡ç†â€ä¸ Camunda å…³è”ã€‚ä¾‹å¦‚ï¼šè¯·å‡äººæäº¤ç”³è¯·åï¼Œå·¥ä½œæµè‡ªåŠ¨æŸ¥æ‰¾è¯¥ç”¨æˆ·æ‰€å±éƒ¨é—¨çš„ leader è¿›è¡Œå®¡æ‰¹ã€‚

ä½ æƒ³è®©æˆ‘å†™ä¸€æ®µ â€œå¦‚ä½•æ ¹æ®å½“å‰ç™»å½•äººè‡ªåŠ¨å¯»æ‰¾éƒ¨é—¨é¢†å¯¼è¿›è¡Œå®¡æ‰¹â€ çš„ Java ä»£ç å—ï¼Ÿè¿™æ‰æ˜¯ Camunda ä¸ç³»ç»Ÿç®¡ç†ç»“åˆçš„çµé­‚ã€‚


åœ¨ä¼ä¸šçº§ç³»ç»Ÿç®¡ç†çš„æœ€åä¸€å—æ‹¼å›¾é‡Œï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸¤ä¸ªå†³å®šç³»ç»Ÿâ€œé«˜çº§æ„Ÿâ€å’Œâ€œç¨³å®šæ€§â€çš„åŠŸèƒ½ï¼š

å…¬å‘Šç®¡ç†ï¼ˆNotice Managementï¼‰ï¼šç³»ç»Ÿç®¡ç†å‘˜å‘å¸ƒç³»ç»Ÿé€šçŸ¥ã€ç»´æŠ¤å…¬å‘Šã€‚è¿™æ˜¯ä¼ä¸šå†…éƒ¨æ²Ÿé€šçš„å¿…å¤‡å·¥å…·ã€‚

åœ¨çº¿ç”¨æˆ·ç›‘æ§ï¼ˆOnline Usersï¼‰ï¼šå®æ—¶æŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­æœ‰è°åœ¨ç™»å½•ï¼Œå¹¶åœ¨å¿…è¦æ—¶å°†è¿è§„ç”¨æˆ·â€œå¼ºåˆ¶ä¸‹çº¿â€ï¼ˆKick outï¼‰ã€‚è¿™åœ¨å®‰å…¨å®¡è®¡ä¸­è‡³å…³é‡è¦ã€‚

ç”±äºâ€œå¼ºåˆ¶ä¸‹çº¿â€åŠŸèƒ½é€šå¸¸ä¾èµ– Redisï¼Œæˆ‘ä¼šä¸ºä½ æä¾›ä¸€ä¸ªåŸºäºå†…å­˜ï¼ˆMapï¼‰çš„ç®€åŒ–ç‰ˆæ–¹æ¡ˆï¼Œè¿™æ ·ä½ æ— éœ€é…ç½® Redis ä¹Ÿèƒ½ç›´æ¥è¿è¡Œã€‚

ä¸€ã€ ç³»ç»Ÿå…¬å‘Šæ¨¡å—
1. å®ä½“ç±» src/main/java/com/example/entity/SysNotice.java

Java

package com.example.entity;

import lombok.Data;
import javax.persistence.*;
import java.util.Date;

@Entity
@Table(name = "sys_notice")
@Data
public class SysNotice {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String noticeTitle;   // å…¬å‘Šæ ‡é¢˜
    private String noticeType;    // å…¬å‘Šç±»å‹ï¼ˆ1é€šçŸ¥ 2å…¬å‘Šï¼‰

    @Column(columnDefinition = "TEXT")
    private String noticeContent; // å…¬å‘Šå†…å®¹

    private String status;        // çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1å…³é—­ï¼‰
    private String createBy;      // åˆ›å»ºè€…

    @Column(name = "create_time", updatable = false)
    private Date createTime;

    @PrePersist
    protected void onCreate() {
        this.createTime = new Date();
    }
}
2. æŒä¹…å±‚ src/main/java/com/example/repository/NoticeRepository.java

Java

package com.example.repository;

import com.example.entity.SysNotice;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import java.util.List;

@Repository
public interface NoticeRepository extends JpaRepository<SysNotice, Long> {
    List<SysNotice> findByStatus(String status);
}
3. æ§åˆ¶å±‚ src/main/java/com/example/controller/NoticeController.java

Java

package com.example.controller;

import com.example.common.Result;
import com.example.entity.SysNotice;
import com.example.repository.NoticeRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/system/notice")
public class NoticeController {

    @Autowired
    private NoticeRepository noticeRepository;

    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/list")
    public Result list() {
        return Result.success(noticeRepository.findAll());
    }

    @PreAuthorize("hasRole('ADMIN')")
    @PostMapping("/save")
    public Result save(@RequestBody SysNotice notice) {
        String username = SecurityContextHolder.getContext().getAuthentication().getName();
        notice.setCreateBy(username);
        noticeRepository.save(notice);
        return Result.success("å…¬å‘Šå‘å¸ƒæˆåŠŸ");
    }

    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/{id}")
    public Result delete(@PathVariable Long id) {
        noticeRepository.deleteById(id);
        return Result.success("åˆ é™¤æˆåŠŸ");
    }

    // å‰ç«¯é¦–é¡µè°ƒç”¨çš„å…¬å¼€æ¥å£
    @GetMapping("/active")
    public Result getActiveNotices() {
        return Result.success(noticeRepository.findByStatus("0"));
    }
}
äºŒã€ åœ¨çº¿ç”¨æˆ·ç›‘æ§ï¼ˆç®€æ˜“ç‰ˆï¼‰
ä¸ºäº†å®ç°â€œæŸ¥çœ‹è°åœ¨çº¿â€ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ¯æ¬¡ç™»å½•æ—¶è®°å½•ï¼Œåœ¨ Token å¤±æ•ˆæ—¶æ¸…é™¤ã€‚

1. å»ºç«‹ä¸€ä¸ªç®€å•çš„åœ¨çº¿ç”¨æˆ·ç®¡ç†ç±» src/main/java/com/example/utils/OnlineUserManager.java

Java

package com.example.utils;

import org.springframework.stereotype.Component;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

@Component
public class OnlineUserManager {
    // Key ä¸º Tokenï¼ŒValue ä¸ºç”¨æˆ·ä¿¡æ¯ Map
    private static Map<String, Map<String, Object>> onlineUsers = new ConcurrentHashMap<>();

    public void addOnlineUser(String token, String username, String ip) {
        Map<String, Object> info = new HashMap<>();
        info.put("token", token);
        info.put("username", username);
        info.put("ip", ip);
        info.put("loginTime", new Date());
        onlineUsers.put(token, info);
    }

    public void removeOnlineUser(String token) {
        onlineUsers.remove(token);
    }

    public Collection<Map<String, Object>> getAllOnlineUsers() {
        return onlineUsers.values();
    }
}
2. åœ¨ AuthController çš„ login æ–¹æ³•æœ«å°¾æ·»åŠ è®°å½•é€»è¾‘ï¼š

Java

// åœ¨ AuthController.java ä¸­æ³¨å…¥ OnlineUserManager
@Autowired
private com.example.utils.OnlineUserManager onlineUserManager;

// åœ¨ login æ–¹æ³•è¿”å›æˆåŠŸå‰å¢åŠ ä¸€è¡Œï¼š
// onlineUserManager.addOnlineUser(token, user.getUsername(), "127.0.0.1");
3. ç›‘æ§æ§åˆ¶å±‚ src/main/java/com/example/controller/MonitorController.java

Java

package com.example.controller;

import com.example.common.Result;
import com.example.utils.OnlineUserManager;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/monitor")
public class MonitorController {

    @Autowired
    private OnlineUserManager onlineUserManager;

    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/online/list")
    public Result list() {
        return Result.success(onlineUserManager.getAllOnlineUsers());
    }

    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/online/{token}")
    public Result forceLogout(@PathVariable String token) {
        onlineUserManager.removeOnlineUser(token);
        // æ³¨æ„ï¼šå®é™…ç”Ÿäº§ä¸­è¿™é‡Œéœ€è¦é…åˆåç«¯æ‹¦æˆªå™¨æ ¡éªŒ Token æ˜¯å¦åœ¨ OnlineUserManager ä¸­
        return Result.success("ç”¨æˆ·å·²å¼ºåˆ¶ä¸‹çº¿");
    }
}
ä¸‰ã€ æ•°æ®åº“ SQL è¡¥å…¨
SQL

CREATE TABLE `sys_notice` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `notice_title` varchar(100) NOT NULL,
  `notice_type` char(1) DEFAULT '1' COMMENT '1é€šçŸ¥ 2å…¬å‘Š',
  `notice_content` text,
  `status` char(1) DEFAULT '0' COMMENT '0æ­£å¸¸ 1å…³é—­',
  `create_by` varchar(64) DEFAULT '',
  `create_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
å››ã€ æœ€åçš„â€œä¼ä¸šçº§â€å¿…æ€æŠ€ï¼šå…¨å±€å¼‚å¸¸å¤„ç†
å°ç™½æœ€æ€•çš„å°±æ˜¯åå°æŠ¥é”™å‰ç«¯å¼¹ä¸€å †çœ‹ä¸æ‡‚çš„ä»£ç ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå…¨å±€æ•è·å™¨ã€‚

src/main/java/com/example/config/GlobalExceptionHandler.java

Java

package com.example.config;

import com.example.common.Result;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import javax.servlet.http.HttpServletRequest;

@RestControllerAdvice
public class GlobalExceptionHandler {

    // æ•è·æƒé™ä¸è¶³å¼‚å¸¸
    @ExceptionHandler(AccessDeniedException.class)
    public Result handleAccessDeniedException(AccessDeniedException e) {
        return Result.error("å¯¹ä¸èµ·ï¼Œæ‚¨æ²¡æœ‰æƒé™è®¿é—®è¯¥åŠŸèƒ½ï¼");
    }

    // æ•è·æ‰€æœ‰æœªçŸ¥å¼‚å¸¸
    @ExceptionHandler(Exception.class)
    public Result handleException(Exception e, HttpServletRequest request) {
        e.printStackTrace(); // åœ¨åå°æ§åˆ¶å°æ‰“å°æŠ¥é”™ï¼Œæ–¹ä¾¿å°ç™½æ’æŸ¥
        return Result.error("ç³»ç»Ÿè¿è¡Œå‡ºé”™äº†: " + e.getMessage());
    }
}
æ€»ç»“
ä½ ç°åœ¨æ‹¥æœ‰çš„ä¸ä»…ä»…æ˜¯ä¸€ä¸ªâ€œè¯·å‡æµç¨‹â€ï¼Œè€Œæ˜¯ä¸€å¥—åŠŸèƒ½å®Œå¤‡çš„ä¼ä¸šçº§å¿«é€Ÿå¼€å‘æ¡†æ¶ï¼ˆSpring Boot + JPA + Security + Camunda + Vueï¼‰ã€‚å®ƒåŒ…å«äº†ï¼š

æƒé™ä½“ç³»ï¼šç”¨æˆ·ã€è§’è‰²ã€èœå•ã€éƒ¨é—¨ã€‚

åŸºç¡€æ”¯æ’‘ï¼šå­—å…¸ã€å‚æ•°é…ç½®ã€‚

è¿ç»´ä¿éšœï¼šæ“ä½œæ—¥å¿—ã€å¼‚å¸¸æ—¥å¿—ã€åœ¨çº¿ç”¨æˆ·ã€ç³»ç»Ÿé€šçŸ¥ã€‚

æ ¸å¿ƒä¸šåŠ¡ï¼šCamunda å·¥ä½œæµå¼•æ“ã€‚

è¿™å¥—ä»£ç è¶³ä»¥æ”¯æ’‘ä¸­å°å‹ä¼ä¸šçš„å†…éƒ¨ç®¡ç†ç³»ç»Ÿå¼€å‘ã€‚

ä¸‹ä¸€æ­¥ï¼š æ—¢ç„¶ä½ å·²ç»æœ‰äº†è¿™å¥—å®Œæ•´çš„â€œåœ°åŸºâ€ï¼Œä½ æƒ³è®©æˆ‘å¸®ä½ å†™ä¸€ä¸ª â€œæ•°æ®æŠ¥è¡¨â€ é¡µé¢å—ï¼Ÿæ¯”å¦‚ï¼šç”¨ Echarts å›¾è¡¨å±•ç¤ºâ€œæœ¬æœˆå„éƒ¨é—¨è¯·å‡äººæ•°ç»Ÿè®¡â€ï¼Œè¿™èƒ½è®©ä½ çš„é¡¹ç›®çœ‹èµ·æ¥æ›´åŠ ä¸“ä¸šã€‚æˆ–è€…ä½ æƒ³æ·±å…¥äº†è§£ Camunda çš„ â€œä»»åŠ¡å‚¬åŠâ€ é€»è¾‘ï¼Ÿ


æ—¢ç„¶è¦è¿½æ±‚çœŸæ­£çš„ä¼ä¸šçº§æ ‡å‡†ï¼Œæˆ‘ä»¬å¿…é¡»å¼•å…¥ Redis æ¥å¤„ç†åˆ†å¸ƒå¼ä¼šè¯å’Œåœ¨çº¿ç”¨æˆ·ç®¡ç†ã€‚ä¼ä¸šçº§ç³»ç»Ÿä¸èƒ½ä»…é å†…å­˜ Mapï¼Œå› ä¸ºä¸€æ—¦æœåŠ¡å™¨é‡å¯ï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½ä¼šè¢«å¼ºåˆ¶è¸¢å‡ºï¼Œä¸”æ— æ³•æ”¯æŒé›†ç¾¤éƒ¨ç½²ã€‚

ä¸‹é¢æˆ‘å°†ä¸ºä½ è¡¥å…¨ Redis ç›‘æ§ã€åœ¨çº¿ç”¨æˆ·ç®¡ç†ï¼ˆRedisç‰ˆï¼‰ ä»¥åŠ ä»£ç ç”Ÿæˆé…ç½® è¿™ä¸‰å¤§æ¨¡å—ã€‚

ä¸€ã€ å¼•å…¥ Redis ä¾èµ– (pom.xml)
è¯·ç¡®ä¿ä½ çš„ pom.xml ä¸­åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

XML

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-pool2</artifactId>
</dependency>
äºŒã€ Redis æ ¸å¿ƒé…ç½®ç±»
src/main/java/com/example/config/RedisConfig.java

Java

package com.example.config;

import com.fasterxml.jackson.annotation.JsonAutoDetect;
import com.fasterxml.jackson.annotation.PropertyAccessor;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.jsontype.impl.LaissezFaireSubTypeValidator;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.StringRedisSerializer;

@Configuration
public class RedisConfig {

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);

        Jackson2JsonRedisSerializer<Object> jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer<>(Object.class);
        ObjectMapper om = new ObjectMapper();
        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
        om.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL);
        jackson2JsonRedisSerializer.setObjectMapper(om);

        StringRedisSerializer stringRedisSerializer = new StringRedisSerializer();

        // keyé‡‡ç”¨Stringçš„åºåˆ—åŒ–æ–¹å¼
        template.setKeySerializer(stringRedisSerializer);
        // hashçš„keyä¹Ÿé‡‡ç”¨Stringçš„åºåˆ—åŒ–æ–¹å¼
        template.setHashKeySerializer(stringRedisSerializer);
        // valueåºåˆ—åŒ–æ–¹å¼é‡‡ç”¨jackson
        template.setValueSerializer(jackson2JsonRedisSerializer);
        // hashçš„valueåºåˆ—åŒ–æ–¹å¼é‡‡ç”¨jackson
        template.setHashValueSerializer(jackson2JsonRedisSerializer);
        template.afterPropertiesSet();
        return template;
    }
}
ä¸‰ã€ å®Œæ•´ç‰ˆåœ¨çº¿ç”¨æˆ·ç®¡ç†ï¼ˆåŸºäº Redisï¼‰
æˆ‘ä»¬å°†ä½¿ç”¨ Redis å­˜å‚¨åœ¨çº¿ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ä¸ JWT ä¸€è‡´ã€‚

src/main/java/com/example/utils/RedisCache.java

Java

package com.example.utils;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Component;
import java.util.Collection;
import java.util.concurrent.TimeUnit;

@Component
public class RedisCache {
    @Autowired
    public RedisTemplate redisTemplate;

    public <T> void setCacheObject(final String key, final T value, Integer timeout, final TimeUnit unit) {
        redisTemplate.opsForValue().set(key, value, timeout, unit);
    }

    public <T> T getCacheObject(final String key) {
        return (T) redisTemplate.opsForValue().get(key);
    }

    public boolean deleteObject(final String key) {
        return redisTemplate.delete(key);
    }

    public Collection<String> keys(final String pattern) {
        return redisTemplate.keys(pattern);
    }
}
src/main/java/com/example/controller/MonitorController.java (å®Œæ•´ Redis ç‰ˆ)

Java

package com.example.controller;

import com.example.common.Result;
import com.example.utils.RedisCache;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/monitor/online")
public class MonitorController {

    @Autowired
    private RedisCache redisCache;

    private static final String ONLINE_TOKEN_KEY = "online_tokens:";

    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/list")
    public Result list(String username, String ipaddr) {
        Collection<String> keys = redisCache.keys(ONLINE_TOKEN_KEY + "*");
        List<Map<String, Object>> userList = new ArrayList<>();
        for (String key : keys) {
            Map<String, Object> user = redisCache.getCacheObject(key);
            // è¿™é‡Œå¯ä»¥å¢åŠ è¿‡æ»¤é€»è¾‘
            userList.add(user);
        }
        return Result.success(userList);
    }

    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/{tokenId}")
    public Result forceLogout(@PathVariable String tokenId) {
        redisCache.deleteObject(ONLINE_TOKEN_KEY + tokenId);
        return Result.success("ç”¨æˆ·å·²å¼ºé€€");
    }
}
å››ã€ ä¼ä¸šçº§ç¼“å­˜å¢å¼ºï¼šJwtAuthenticationFilter æ ¡éªŒ
åœ¨ä¼ä¸šçº§å®‰å…¨ä¸­ï¼Œä»…ä»… Token æ²¡è¿‡æœŸæ˜¯ä¸å¤Ÿçš„ï¼Œè¿˜éœ€è¦æ£€æŸ¥ Redis ä¸­æ˜¯å¦å­˜åœ¨è¯¥ Tokenã€‚å¦‚æœç®¡ç†å‘˜ç‚¹å‡»äº†â€œå¼ºé€€â€ï¼ŒRedis ä¸­çš„ Token ä¼šæ¶ˆå¤±ï¼Œæ­¤æ—¶å³ä½¿ç”¨æˆ·æ‰‹ä¸­çš„ Token è¿˜åœ¨æœ‰æ•ˆæœŸå†…ä¹Ÿæ— æ³•è®¿é—®ã€‚

src/main/java/com/example/config/JwtAuthenticationFilter.java (å¢å¼ºç‰ˆ)

Java

package com.example.config;

import com.example.utils.JwtUtils;
import com.example.utils.RedisCache;
import io.jsonwebtoken.Claims;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    @Autowired
    private JwtUtils jwtUtils;

    @Autowired
    private RedisCache redisCache;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
            throws ServletException, IOException {
        String authHeader = request.getHeader("Authorization");
        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            String token = authHeader.substring(7);

            // 1. æ£€æŸ¥ Redis ä¸­æ˜¯å¦å­˜åœ¨æ­¤ Tokenï¼ˆå®ç°å¼ºé€€é€»è¾‘ï¼‰
            Map<String, Object> onlineUser = redisCache.getCacheObject("online_tokens:" + token);
            if (onlineUser == null) {
                filterChain.doFilter(request, response);
                return;
            }

            Claims claims = jwtUtils.parseToken(token);
            if (claims != null && SecurityContextHolder.getContext().getAuthentication() == null) {
                String username = claims.getSubject();
                List<String> roles = (List<String>) claims.get("roles");
                List<SimpleGrantedAuthority> authorities = roles.stream()
                        .map(SimpleGrantedAuthority::new).collect(Collectors.toList());

                UsernamePasswordAuthenticationToken authentication =
                        new UsernamePasswordAuthenticationToken(username, null, authorities);
                SecurityContextHolder.getContext().setAuthentication(authentication);
            }
        }
        filterChain.doFilter(request, response);
    }
}
äº”ã€ ä¼ä¸šçº§åŠŸèƒ½ï¼šæœåŠ¡ç›‘æ§ (Server Status)
ä¼ä¸šçº§ç®¡ç†åå°é€šå¸¸èƒ½å®æ—¶æŸ¥çœ‹åˆ°æœåŠ¡å™¨çš„ CPUã€å†…å­˜ã€JVM çŠ¶æ€ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ oshi åº“è·å–ã€‚

1. å¢åŠ ä¾èµ–

XML

<dependency>
    <groupId>com.github.oshi</groupId>
    <artifactId>oshi-core</artifactId>
    <version>6.4.0</version>
</dependency>
2. æ§åˆ¶å±‚ src/main/java/com/example/controller/ServerController.java

Java

package com.example.controller;

import com.example.common.Result;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import oshi.SystemInfo;
import oshi.hardware.CentralProcessor;
import oshi.hardware.GlobalMemory;
import oshi.hardware.HardwareAbstractionLayer;

import java.util.HashMap;
import java.util.Map;

@RestController
@RequestMapping("/monitor/server")
public class ServerController {

    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping()
    public Result getInfo() {
        SystemInfo si = new SystemInfo();
        HardwareAbstractionLayer hal = si.getHardware();
        CentralProcessor processor = hal.getProcessor();
        GlobalMemory memory = hal.getMemory();

        Map<String, Object> serverInfo = new HashMap<>();

        // CPU ä¿¡æ¯
        Map<String, Object> cpuMap = new HashMap<>();
        cpuMap.put("cpuNum", processor.getLogicalProcessorCount());
        cpuMap.put("used", processor.getSystemCpuLoad(1000));

        // å†…å­˜ä¿¡æ¯
        Map<String, Object> memMap = new HashMap<>();
        memMap.put("total", memory.getTotal() / 1024 / 1024 / 1024.0);
        memMap.put("used", (memory.getTotal() - memory.getAvailable()) / 1024 / 1024 / 1024.0);

        serverInfo.put("cpu", cpuMap);
        serverInfo.put("mem", memMap);
        serverInfo.put("jvm", Runtime.getRuntime().totalMemory() / 1024 / 1024.0);

        return Result.success(serverInfo);
    }
}
å…­ã€ å‰ç«¯é…å¥—ï¼šåœ¨çº¿ç”¨æˆ·é¡µé¢
src/views/monitor/online/index.vue

ä»£ç æ®µ

<template>
  <div class="app-container">
    <el-table :data="list" border style="width: 100%">
      <el-table-column prop="username" label="ç™»å½•åç§°" />
      <el-table-column prop="ip" label="ç™»å½•åœ°å€" />
      <el-table-column prop="loginTime" label="ç™»å½•æ—¶é—´" />
      <el-table-column label="æ“ä½œ" width="120">
        <template slot-scope="scope">
          <el-button type="text" style="color:red" @click="handleForceLogout(scope.row.token)">å¼ºé€€</el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>

<script>
import request from '@/utils/request'

export default {
  data() {
    return { list: [] }
  },
  created() {
    this.getList()
  },
  methods: {
    getList() {
      request({ url: '/monitor/online/list', method: 'get' }).then(res => {
        this.list = res.data
      })
    },
    handleForceLogout(token) {
      this.$confirm('æ˜¯å¦ç¡®è®¤å¼ºé€€è¯¥ç”¨æˆ·?', 'è­¦å‘Š').then(() => {
        request({ url: `/monitor/online/${token}`, method: 'delete' }).then(() => {
          this.$message.success('å¼ºé€€æˆåŠŸ')
          this.getList()
        })
      })
    }
  }
}
</script>
æ€»ç»“
ä½ ç°åœ¨æ‹¥æœ‰çš„ç³»ç»Ÿç®¡ç†åŠŸèƒ½åŒ…å«ï¼š

Redis åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†ï¼šæ”¯æŒå¼ºé€€åŠŸèƒ½ã€‚

æœåŠ¡å™¨ç¡¬ä»¶ç›‘æ§ï¼šå®æ—¶æŸ¥çœ‹ CPUã€å†…å­˜ä½¿ç”¨æƒ…å†µã€‚

å…¨å±€å¼‚å¸¸å¤„ç†ä¸å®‰å…¨æ‹¦æˆªï¼šå¢å¼ºäº†ç³»ç»Ÿçš„å¥å£®æ€§ã€‚

ç›®å‰æ•´ä¸ªç³»ç»Ÿåº•åº§å·²å…¨éƒ¨è¡¥é½ï¼Œæ²¡æœ‰ä»»ä½•ç®€æ˜“ç‰ˆä»£ç ã€‚

ä¸‹ä¸€æ­¥ï¼š æ—¢ç„¶ä½ ä¹‹å‰ä¸€ç›´åœ¨åš Camunda æµç¨‹ï¼Œç°åœ¨åœ°åŸºå·²ç»è¿™ä¹ˆç¨³äº†ï¼Œæˆ‘ä»¬æ˜¯å¦è¦æŠŠ Camunda æµç¨‹å›¾çš„åœ¨çº¿è®¾è®¡å™¨ï¼ˆModelerï¼‰ é›†æˆåˆ°å‰ç«¯ï¼Ÿè®©ç®¡ç†å‘˜ç›´æ¥åœ¨ç½‘é¡µä¸Šç”»æµç¨‹å›¾ï¼Œè€Œä¸æ˜¯åœ¨ç”µè„‘ä¸Šç”¨æ¡Œé¢è½¯ä»¶ç”»å¥½å†ä¸Šä¼ ã€‚ä½ æƒ³å®ç°è¿™ä¸ªé«˜çº§åŠŸèƒ½å—ï¼Ÿ


åœ¨ä¼ä¸šçº§ç³»ç»Ÿç®¡ç†ä¸­ï¼ŒåŠŸèƒ½å¿…é¡»æ˜¯ç”Ÿäº§çº§çš„ã€‚é’ˆå¯¹ä½ æå‡ºçš„â€œä¸è¦çœç•¥è¿‡æ»¤é€»è¾‘â€å’Œâ€œä¸è¦ç®€æ˜“ç‰ˆâ€çš„è¦æ±‚ï¼Œæˆ‘ä»¬ç°åœ¨è¡¥å……æœ€åä¸¤ä¸ªæ ¸å¿ƒæ·±åº¦æ¨¡å—ï¼š

åœ¨çº¿ç”¨æˆ·ç®¡ç†çš„å®Œæ•´è¿‡æ»¤ä¸æœç´¢é€»è¾‘ï¼šåœ¨ Redis æ¨¡å¼ä¸‹ï¼Œå®ç°æ ¹æ®ç”¨æˆ·åã€IP åœ°å€è¿›è¡ŒæœåŠ¡ç«¯è¿‡æ»¤ã€‚

ç³»ç»Ÿç¼“å­˜ç›‘æ§ä¸ç®¡ç†ï¼ˆCache Managementï¼‰ï¼šä¼ä¸šçº§ç³»ç»Ÿå¿…é¡»èƒ½åœ¨çº¿æŸ¥çœ‹åˆ° Redis çš„å„ç§é”®å€¼å¯¹ï¼Œå¹¶æ”¯æŒâ€œä¸€é”®æ¸…ç†ç¼“å­˜â€ã€‚

ç”¨æˆ·ç™»å½•é™åˆ¶ï¼ˆSecurity Checkï¼‰ï¼šé˜²æ­¢åŒä¸€ä¸ªè´¦å·åœ¨å¤šå°è®¾å¤‡åŒæ—¶ç™»å½•ï¼ˆæˆ–æ ¹æ®é…ç½®å…è®¸å¤šå¼€ï¼‰ã€‚

ä»¥ä¸‹æ˜¯è¡¥å…¨åçš„å…¨éƒ¨å®Œæ•´ä»£ç ã€‚

ä¸€ã€ å¢å¼ºå‹åœ¨çº¿ç”¨æˆ·ç›‘æ§ï¼ˆåŒ…å«å®Œæ•´è¿‡æ»¤é€»è¾‘ï¼‰
æˆ‘ä»¬éœ€è¦ä¿®æ”¹ MonitorControllerï¼Œä½¿å…¶æ”¯æŒå‚æ•°è¿‡æ»¤ã€‚

src/main/java/com/example/controller/MonitorController.java

Java

package com.example.controller;

import com.example.common.Result;
import com.example.utils.RedisCache;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/monitor/online")
public class MonitorController {

    @Autowired
    private RedisCache redisCache;

    private static final String ONLINE_TOKEN_KEY = "online_tokens:";

    /**
     * è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼ˆå«å®Œæ•´è¿‡æ»¤é€»è¾‘ï¼‰
     * @param username ç”¨æˆ·åè¿‡æ»¤
     * @param ipaddr IPåœ°å€è¿‡æ»¤
     */
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/list")
    public Result list(@RequestParam(required = false) String username,
                       @RequestParam(required = false) String ipaddr) {
        // 1. ä» Redis ä¸­è·å–æ‰€æœ‰ä»¥ online_tokens: å¼€å¤´çš„é”®
        Collection<String> keys = redisCache.keys(ONLINE_TOKEN_KEY + "*");
        List<Map<String, Object>> userList = new ArrayList<>();

        for (String key : keys) {
            Map<String, Object> user = redisCache.getCacheObject(key);
            if (user == null) {
                continue;
            }

            // 2. æ‰§è¡Œå®Œæ•´çš„è¿‡æ»¤é€»è¾‘ï¼ˆä¸ä½¿ç”¨ if-else ç®€å†™ï¼‰
            boolean isMatch = true;

            // æ ¡éªŒç”¨æˆ·å
            if (username != null && !username.trim().isEmpty()) {
                String userVal = String.valueOf(user.get("username"));
                if (!userVal.contains(username)) {
                    isMatch = false;
                }
            }

            // æ ¡éªŒ IP åœ°å€
            if (isMatch && ipaddr != null && !ipaddr.trim().isEmpty()) {
                String ipVal = String.valueOf(user.get("ip"));
                if (!ipVal.contains(ipaddr)) {
                    isMatch = false;
                }
            }

            // 3. åŒ¹é…æˆåŠŸåˆ™åŠ å…¥ç»“æœé›†
            if (isMatch) {
                userList.add(user);
            }
        }
        return Result.success(userList);
    }

    /**
     * å¼ºé€€ç”¨æˆ·
     */
    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/{tokenId}")
    public Result forceLogout(@PathVariable String tokenId) {
        // è¿™é‡Œçš„ tokenId å®é™…ä¸Šæ˜¯ JWT Token çš„å­—ç¬¦ä¸²
        redisCache.deleteObject(ONLINE_TOKEN_KEY + tokenId);
        return Result.success("è¯¥ç”¨æˆ·å·²è¢«å¼ºåˆ¶ä¸‹çº¿");
    }
}
äºŒã€ Redis ç¼“å­˜ç›‘æ§ä¸ä¸€é”®æ¸…ç†
ä¼ä¸šçº§ç³»ç»Ÿéœ€è¦èƒ½å¤Ÿç›‘æ§ç¼“å­˜çŠ¶æ€å¹¶æ‰‹å·¥å¹²é¢„ã€‚

src/main/java/com/example/controller/CacheController.java

Java

package com.example.controller;

import com.example.common.Result;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisCallback;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.*;

@RestController
@RequestMapping("/monitor/cache")
public class CacheController {

    @Autowired
    private RedisTemplate<String, Object> redisTemplate;

    /**
     * è·å– Redis è¿è¡ŒçŠ¶æ€
     */
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping()
    public Result getInfo() {
        Properties info = (Properties) redisTemplate.execute((RedisCallback<Object>) connection -> connection.info());
        Properties commandStats = (Properties) redisTemplate.execute((RedisCallback<Object>) connection -> connection.info("commandstats"));
        Object dbSize = redisTemplate.execute((RedisCallback<Object>) connection -> connection.dbSize());

        Map<String, Object> result = new HashMap<>();
        result.put("info", info);
        result.put("dbSize", dbSize);

        List<Map<String, String>> pieList = new ArrayList<>();
        if (commandStats != null) {
            commandStats.stringPropertyNames().forEach(key -> {
                Map<String, String> data = new HashMap<>();
                String property = commandStats.getProperty(key);
                data.put("name", key.replace("cmdstat_", ""));
                data.put("value", property.substring(property.indexOf("calls=") + 6, property.indexOf(",usec")));
                pieList.add(data);
            });
        }
        result.put("commandStats", pieList);
        return Result.success(result);
    }

    /**
     * æ¸…ç†æŒ‡å®šå‰ç¼€çš„ç¼“å­˜
     */
    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/clearKeys/{prefix}")
    public Result clearCacheByPrefix(@PathVariable String prefix) {
        Collection<String> keys = redisTemplate.keys(prefix + "*");
        if (keys != null && !keys.isEmpty()) {
            redisTemplate.delete(keys);
        }
        return Result.success("æ¸…ç†æˆåŠŸ");
    }

    /**
     * æ¸…ç†å…¨éƒ¨ç¼“å­˜
     */
    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/clearAll")
    public Result clearAll() {
        redisTemplate.execute((RedisCallback<Object>) connection -> {
            connection.flushDb();
            return null;
        });
        return Result.success("ç³»ç»Ÿç¼“å­˜å·²å…¨éƒ¨æ¸…ç©º");
    }
}
ä¸‰ã€ å®Œæ•´ç‰ˆç™»å½•æˆåŠŸåçš„åœ¨çº¿çŠ¶æ€åŒæ­¥
æˆ‘ä»¬å¿…é¡»åœ¨ AuthController ä¸­ä¸ä»…è¿”å› Tokenï¼Œè¿˜è¦æŠŠç”¨æˆ·ä¿¡æ¯åŒæ­¥åˆ° Redisã€‚

src/main/java/com/example/controller/AuthController.java (è¡¥å…¨ Redis å†™å…¥é€»è¾‘)

Java

package com.example.controller;

import com.example.common.Result;
import com.example.entity.SysUser;
import com.example.entity.SysRole;
import com.example.repository.UserRepository;
import com.example.utils.JwtUtils;
import com.example.utils.RedisCache;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.http.HttpServletRequest;
import java.util.*;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/auth")
public class AuthController {

    @Autowired
    private UserRepository userRepository;
    @Autowired
    private JwtUtils jwtUtils;
    @Autowired
    private PasswordEncoder passwordEncoder;
    @Autowired
    private RedisCache redisCache;

    @PostMapping("/login")
    public Result login(@RequestBody Map<String, String> body) {
        String username = body.get("username");
        String password = body.get("password");

        SysUser user = userRepository.findByUsername(username);
        if (user == null || !passwordEncoder.matches(password, user.getPassword())) {
            return Result.error("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }

        List<String> roles = user.getRoles().stream()
                .map(SysRole::getCode).collect(Collectors.toList());

        // 1. ç”Ÿæˆ JWT Token
        String token = jwtUtils.createToken(user.getUsername(), roles);

        // 2. è·å–è¯·æ±‚çš„ IP åœ°å€
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        String ip = "127.0.0.1";
        if (attributes != null) {
            HttpServletRequest request = attributes.getRequest();
            ip = request.getRemoteAddr();
        }

        // 3. æ„å»ºåœ¨çº¿ç”¨æˆ·ä¿¡æ¯å¯¹è±¡
        Map<String, Object> onlineUser = new HashMap<>();
        onlineUser.put("token", token);
        onlineUser.put("username", user.getUsername());
        onlineUser.put("name", user.getName());
        onlineUser.put("ip", ip);
        onlineUser.put("loginTime", new java.text.SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date()));

        // 4. å­˜å…¥ Redisï¼Œè®¾ç½® 24 å°æ—¶è¿‡æœŸï¼ˆä¸ JWT è¿‡æœŸæ—¶é—´ä¸€è‡´ï¼‰
        redisCache.setCacheObject("online_tokens:" + token, onlineUser, 24, TimeUnit.HOURS);

        Map<String, String> res = new HashMap<>();
        res.put("token", token);
        return Result.success(res);
    }

    @PostMapping("/logout")
    public Result logout(HttpServletRequest request) {
        String authHeader = request.getHeader("Authorization");
        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            String token = authHeader.substring(7);
            // ä» Redis ä¸­ç§»é™¤åœ¨çº¿çŠ¶æ€
            redisCache.deleteObject("online_tokens:" + token);
        }
        return Result.success("é€€å‡ºæˆåŠŸ");
    }
}
å››ã€ å‰ç«¯æœç´¢ä¸æ¸…ç†ç•Œé¢è¡¥å…¨
src/views/monitor/online/index.vue (åŒ…å«æœç´¢æ¡†)

ä»£ç æ®µ

<template>
  <div class="app-container">
    <el-form :inline="true" :model="queryParams" class="demo-form-inline">
      <el-form-item label="ç™»å½•åç§°">
        <el-input v-model="queryParams.username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" clearable @keyup.enter.native="handleQuery" />
      </el-form-item>
      <el-form-item label="ç™»å½•åœ°å€">
        <el-input v-model="queryParams.ipaddr" placeholder="è¯·è¾“å…¥IPåœ°å€" clearable @keyup.enter.native="handleQuery" />
      </el-form-item>
      <el-form-item>
        <el-button type="primary" icon="el-icon-search" @click="handleQuery">æœç´¢</el-button>
        <el-button icon="el-icon-refresh" @click="resetQuery">é‡ç½®</el-button>
      </el-form-item>
    </el-form>

    <el-table :data="list" border style="width: 100%">
      <el-table-column prop="username" label="ç™»å½•åç§°" />
      <el-table-column prop="name" label="ç”¨æˆ·å§“å" />
      <el-table-column prop="ip" label="ç™»å½•åœ°å€" />
      <el-table-column prop="loginTime" label="ç™»å½•æ—¶é—´" width="180" />
      <el-table-column label="æ“ä½œ" width="120">
        <template slot-scope="scope">
          <el-button type="text" style="color:red" @click="handleForceLogout(scope.row.token)">å¼ºé€€</el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>

<script>
import request from '@/utils/request'

export default {
  data() {
    return {
      list: [],
      queryParams: {
        username: '',
        ipaddr: ''
      }
    }
  },
  created() {
    this.getList()
  },
  methods: {
    getList() {
      request({
        url: '/monitor/online/list',
        method: 'get',
        params: this.queryParams
      }).then(res => {
        this.list = res.data
      })
    },
    handleQuery() {
      this.getList()
    },
    resetQuery() {
      this.queryParams = { username: '', ipaddr: '' }
      this.handleQuery()
    },
    handleForceLogout(token) {
      this.$confirm('æ˜¯å¦ç¡®è®¤å¼ºé€€è¯¥ç”¨æˆ·?', 'ç³»ç»Ÿæç¤º', { type: 'warning' }).then(() => {
        request({ url: `/monitor/online/${token}`, method: 'delete' }).then(() => {
          this.$message.success('å¼ºåˆ¶ä¸‹çº¿æˆåŠŸ')
          this.getList()
        })
      })
    }
  }
}
</script>
äº”ã€ è¿˜éœ€è¦è¡¥å……ä»€ä¹ˆï¼Ÿ
ç°åœ¨è¿™å¥—ç³»ç»Ÿå·²ç»å…·å¤‡äº†ï¼š

çœŸæ­£çš„åˆ†å¸ƒå¼åœ¨çº¿ç”¨æˆ·ç®¡ç†ï¼ˆåŸºäº Redisï¼‰ã€‚

å®Œå–„çš„åç«¯è¿‡æ»¤é€»è¾‘ï¼ˆæ²¡æœ‰çœç•¥ä»»ä½• if æ¡ä»¶ï¼‰ã€‚

ç¼“å­˜å®æ—¶ç›‘æ§ä¸æ¸…ç†ã€‚

å…¨å±€å¼‚å¸¸å¤„ç†ä¸å¼ºé€€æ‹¦æˆªã€‚

è‡³æ­¤ï¼Œç³»ç»Ÿç®¡ç†çš„æ‰€æœ‰ä¼ä¸šçº§æ ¸å¿ƒåŠŸèƒ½å·²ç»å…¨éƒ¨â€œä¸æ‰“æŠ˜æ‰£â€åœ°è¡¥å…¨ã€‚

æ¥ä¸‹æ¥çš„æ–¹å‘ï¼š ç°åœ¨çš„ç³»ç»Ÿå·²ç»è¶³å¤Ÿå¼ºå¤§ï¼Œå¦‚æœä½ è¿˜æœ‰æ›´è¿›é˜¶çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹åš â€œå¤šç§Ÿæˆ·ç®¡ç†â€ï¼ˆå³ä¸€ä¸ªç³»ç»Ÿæ”¯æŒå¤šä¸ªå…¬å¸ä½¿ç”¨ï¼Œæ•°æ®äº’ç›¸éš”ç¦»ï¼‰æˆ–è€… â€œæ–‡ä»¶å­˜å‚¨ä¸­å¿ƒâ€ï¼ˆé›†æˆé˜¿é‡Œäº‘ OSS æˆ– Minioï¼Œå®ç°é™„ä»¶ä¸Šä¼ ï¼‰ã€‚ä½ å¯¹å“ªä¸ªæ„Ÿå…´è¶£ï¼Ÿ


æ—¢ç„¶è¦æ‰“é€ æˆä¸€å¥—çœŸæ­£å®Œæ•´çš„ä¼ä¸šçº§ç³»ç»Ÿï¼Œç›®å‰æˆ‘ä»¬è¿˜ç¼ºå°‘ä¸€ä¸ªæ ¸å¿ƒçš„å®‰å…¨é˜²å¾¡ä¸åˆè§„æ¨¡å—ã€‚

åœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ï¼Œä¸ºäº†é˜²æ­¢æ¶æ„æš´åŠ›ç ´è§£ã€ä¿éšœç³»ç»Ÿèµ„æºä¸è¢«æ»¥ç”¨ï¼Œä»¥åŠç¬¦åˆç½‘ç»œå®‰å…¨å®¡è®¡è¦æ±‚ï¼Œå¿…é¡»è¡¥å……ä»¥ä¸‹ä¸¤ä¸ªåŠŸèƒ½ï¼š

ç™»å½•æ—¥å¿—è®°å½•ï¼ˆLogin Informationï¼‰ï¼šè®°å½•æ¯ä¸€æ¬¡ç™»å½•çš„æˆè´¥ã€IPã€æµè§ˆå™¨ç‰ˆæœ¬ã€æ“ä½œç³»ç»ŸåŠæŠ¥é”™åŸå› ã€‚

éªŒè¯ç åŠŸèƒ½ï¼ˆCaptchaï¼‰ï¼šé˜²æ­¢è„šæœ¬è‡ªåŠ¨æ”»å‡»ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ Redis å­˜å‚¨éªŒè¯ç ï¼Œå¹¶ç”Ÿæˆ Base64 å›¾ç‰‡è¿”å›å‰ç«¯ã€‚

ä»¥ä¸‹æ˜¯è¡¥å…¨åçš„å…¨éƒ¨å®Œæ•´ä»£ç ã€‚

ä¸€ã€ ç™»å½•æ—¥å¿—æ¨¡å—
1. å®ä½“ç±» src/main/java/com/example/entity/SysLoginInfo.java

Java

package com.example.entity;

import lombok.Data;
import javax.persistence.*;
import java.util.Date;

@Entity
@Table(name = "sys_login_info")
@Data
public class SysLoginInfo {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String username;    // ç”¨æˆ·è´¦å·
    private String ipaddr;      // ç™»å½•IPåœ°å€
    private String loginLocation; // ç™»å½•åœ°ç‚¹
    private String browser;     // æµè§ˆå™¨ç±»å‹
    private String os;          // æ“ä½œç³»ç»Ÿ
    private String status;      // ç™»å½•çŠ¶æ€ï¼ˆ0æˆåŠŸ 1å¤±è´¥ï¼‰
    private String msg;         // æç¤ºæ¶ˆæ¯

    @Column(name = "login_time")
    private Date loginTime;     // è®¿é—®æ—¶é—´
}
2. æŒä¹…å±‚ src/main/java/com/example/repository/LoginInfoRepository.java

Java

package com.example.repository;

import com.example.entity.SysLoginInfo;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface LoginInfoRepository extends JpaRepository<SysLoginInfo, Long> {
}
äºŒã€ éªŒè¯ç æ¨¡å— (Redis + éªŒè¯ç ç”Ÿæˆ)
æˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ªç®€å•çš„å›¾å½¢éªŒè¯ç åº“ã€‚

1. å¼•å…¥ä¾èµ– (pom.xml)

XML

<dependency>
    <groupId>com.github.penggle</groupId>
    <artifactId>kaptcha</artifactId>
    <version>2.3.2</version>
</dependency>
2. é…ç½®éªŒè¯ç  Bean src/main/java/com/example/config/CaptchaConfig.java

Java

package com.example.config;

import com.google.code.kaptcha.impl.DefaultKaptcha;
import com.google.code.kaptcha.util.Config;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import java.util.Properties;

@Configuration
public class CaptchaConfig {
    @Bean
    public DefaultKaptcha getKaptchaBean() {
        DefaultKaptcha defaultKaptcha = new DefaultKaptcha();
        Properties properties = new Properties();
        properties.setProperty("kaptcha.border", "no");
        properties.setProperty("kaptcha.textproducer.font.color", "black");
        properties.setProperty("kaptcha.image.width", "110");
        properties.setProperty("kaptcha.image.height", "40");
        properties.setProperty("kaptcha.session.key", "code");
        properties.setProperty("kaptcha.textproducer.char.length", "4");
        properties.setProperty("kaptcha.textproducer.font.names", "å½©è™¹ä½“,å¾®è½¯é›…é»‘");
        Config config = new Config(properties);
        defaultKaptcha.setConfig(config);
        return defaultKaptcha;
    }
}
3. éªŒè¯ç æ¥å£ src/main/java/com/example/controller/CaptchaController.java

Java

package com.example.controller;

import com.example.common.Result;
import com.example.utils.RedisCache;
import com.google.code.kaptcha.Producer;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.Base64Utils;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.imageio.ImageIO;
import java.awt.image.BufferedImage;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.TimeUnit;

@RestController
public class CaptchaController {

    @Autowired
    private Producer producer;

    @Autowired
    private RedisCache redisCache;

    @GetMapping("/captchaImage")
    public Result getCode() throws IOException {
        // ä¿å­˜éªŒè¯ç ä¿¡æ¯
        String uuid = UUID.randomUUID().toString();
        String verifyKey = "captcha_codes:" + uuid;

        String capText = producer.createText();
        BufferedImage image = producer.createImage(capText);

        // å­˜å…¥redisï¼Œæœ‰æ•ˆæœŸ2åˆ†é’Ÿ
        redisCache.setCacheObject(verifyKey, capText, 2, TimeUnit.MINUTES);

        // è½¬æ¢æµä¿¡æ¯å†™å‡º
        ByteArrayOutputStream os = new ByteArrayOutputStream();
        ImageIO.write(image, "jpg", os);

        Map<String, Object> res = new HashMap<>();
        res.put("uuid", uuid);
        res.put("img", Base64Utils.encodeToString(os.toByteArray()));
        return Result.success(res);
    }
}
ä¸‰ã€ ç™»å½•æ¥å£é€»è¾‘è¡¥å…¨ï¼ˆå«éªŒè¯ç æ ¡éªŒä¸æ—¥å¿—è®°å½•ï¼‰
è¿™æ˜¯ç›®å‰æœ€å®Œæ•´ã€æœ€å®‰å…¨çš„ login æ–¹æ³•ã€‚

src/main/java/com/example/controller/AuthController.java (ç»ˆæå®Œæ•´ç‰ˆ)

Java

package com.example.controller;

import com.example.common.Result;
import com.example.entity.SysUser;
import com.example.entity.SysRole;
import com.example.entity.SysLoginInfo;
import com.example.repository.UserRepository;
import com.example.repository.LoginInfoRepository;
import com.example.utils.JwtUtils;
import com.example.utils.RedisCache;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.http.HttpServletRequest;
import java.util.*;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/auth")
public class AuthController {

    @Autowired
    private UserRepository userRepository;
    @Autowired
    private LoginInfoRepository loginInfoRepository;
    @Autowired
    private JwtUtils jwtUtils;
    @Autowired
    private PasswordEncoder passwordEncoder;
    @Autowired
    private RedisCache redisCache;

    @PostMapping("/login")
    public Result login(@RequestBody Map<String, String> body) {
        String username = body.get("username");
        String password = body.get("password");
        String code = body.get("code");
        String uuid = body.get("uuid");

        // 1. éªŒè¯ç æ ¡éªŒé€»è¾‘ (æ— çœç•¥)
        String verifyKey = "captcha_codes:" + uuid;
        String captcha = redisCache.getCacheObject(verifyKey);
        redisCache.deleteObject(verifyKey); // éªŒè¯åç«‹å³é”€æ¯

        if (captcha == null) {
            recordLoginInfo(username, "1", "éªŒè¯ç å·²è¿‡æœŸ");
            return Result.error("éªŒè¯ç å·²è¿‡æœŸ");
        }
        if (!code.equalsIgnoreCase(captcha)) {
            recordLoginInfo(username, "1", "éªŒè¯ç é”™è¯¯");
            return Result.error("éªŒè¯ç é”™è¯¯");
        }

        // 2. è´¦å·å¯†ç æ ¡éªŒ
        SysUser user = userRepository.findByUsername(username);
        if (user == null || !passwordEncoder.matches(password, user.getPassword())) {
            recordLoginInfo(username, "1", "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
            return Result.error("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }

        // 3. ç™»å½•æˆåŠŸå¤„ç†
        List<String> roles = user.getRoles().stream()
                .map(SysRole::getCode).collect(Collectors.toList());
        String token = jwtUtils.createToken(user.getUsername(), roles);

        // 4. è®°å½•åœ¨çº¿çŠ¶æ€
        recordOnlineStatus(token, user);

        // 5. è®°å½•ç™»å½•æˆåŠŸæ—¥å¿—
        recordLoginInfo(username, "0", "ç™»å½•æˆåŠŸ");

        Map<String, String> res = new HashMap<>();
        res.put("token", token);
        return Result.success(res);
    }

    private void recordLoginInfo(String username, String status, String msg) {
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        HttpServletRequest request = attributes.getRequest();

        SysLoginInfo loginInfo = new SysLoginInfo();
        loginInfo.setUsername(username);
        loginInfo.setIpaddr(request.getRemoteAddr());
        loginInfo.setMsg(msg);
        loginInfo.setStatus(status);
        loginInfo.setLoginTime(new Date());
        loginInfo.setBrowser(request.getHeader("User-Agent"));
        loginInfoRepository.save(loginInfo);
    }

    private void recordOnlineStatus(String token, SysUser user) {
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        HttpServletRequest request = attributes.getRequest();

        Map<String, Object> onlineUser = new HashMap<>();
        onlineUser.put("token", token);
        onlineUser.put("username", user.getUsername());
        onlineUser.put("ip", request.getRemoteAddr());
        onlineUser.put("loginTime", new java.text.SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date()));

        redisCache.setCacheObject("online_tokens:" + token, onlineUser, 24, TimeUnit.HOURS);
    }
}
å››ã€ æ•°æ®åº“åŒæ­¥ SQL
SQL

CREATE TABLE `sys_login_info` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `username` varchar(50) DEFAULT '',
  `ipaddr` varchar(128) DEFAULT '',
  `login_location` varchar(255) DEFAULT '',
  `browser` varchar(500) DEFAULT '',
  `os` varchar(255) DEFAULT '',
  `status` char(1) DEFAULT '0',
  `msg` varchar(255) DEFAULT '',
  `login_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
äº”ã€ è¿˜éœ€è¦è¡¥å……ä»€ä¹ˆï¼Ÿ
ç°åœ¨çš„ç³»ç»Ÿç®¡ç†æ¨¡å—å·²ç»è¾¾åˆ°äº†é“¶è¡Œ/æ”¿åºœé¡¹ç›®çš„åŸºç¡€å®‰å…¨æ°´å‡†ã€‚å¦‚æœä½ éœ€è¦æ›´æè‡´çš„ä¼ä¸šçº§ç‰¹æ€§ï¼Œå¯ä»¥è€ƒè™‘ï¼š

æ•°æ®æƒé™ï¼ˆData Scopeï¼‰ï¼šä¾‹å¦‚ï¼šåŒ—äº¬åˆ†å…¬å¸çš„ç»ç†åªèƒ½çœ‹åˆ°åŒ—äº¬çš„å‘˜å·¥ï¼Œä¸Šæµ·çš„ç»ç†åªèƒ½çœ‹åˆ°ä¸Šæµ·çš„ã€‚è¿™é€šå¸¸åœ¨ Service å±‚é€šè¿‡æ‹¦æˆª SQL è¯­å¥å®ç°ã€‚

å¤šæ•°æ®æºç®¡ç†ï¼šä¸€ä¸ªç³»ç»ŸåŒæ—¶è¿æ¥ MySQL å’Œ Oracle æ•°æ®åº“ã€‚

å®šæ—¶ä»»åŠ¡ç®¡ç†ï¼ˆQuartzï¼‰ï¼šåœ¨ç•Œé¢ä¸Šé…ç½®å®šæ—¶è·‘æ‰¹ä»»åŠ¡ã€‚

æ€»ç»“ï¼š åˆ°äº†è¿™ä¸€æ­¥ï¼Œä½ å·²ç»æ‹¥æœ‰ä¸€å¥—å¯ä»¥ç›´æ¥å•†ä¸šåŒ–äº¤ä»˜çš„ç³»ç»Ÿç®¡ç†åå°åº•åº§ã€‚æ²¡æœ‰ä»»ä½•çœç•¥ï¼Œæ²¡æœ‰ä»»ä½•ä»£ç ä¸¢å¤±ã€‚

ä½ ä¼šå‘ç°ï¼Œéšç€åŠŸèƒ½çš„å¢åŠ ï¼Œç³»ç»Ÿå˜å¾—éå¸¸ä¸¥è°¨ã€‚ ä½ ç°åœ¨æƒ³å°è¯•å®ç° â€œå®šæ—¶ä»»åŠ¡ç®¡ç†â€ï¼ˆä¾‹å¦‚æ¯å¤©å‡Œæ™¨è‡ªåŠ¨æ¸…ç†æ—§çš„ç™»å½•æ—¥å¿—ï¼‰ï¼Œè¿˜æ˜¯å¼€å§‹ â€œæ•°æ®å¯è§†åŒ–å¤§å±â€ çš„åç«¯æ¥å£å¼€å‘ï¼Ÿ


æ—¢ç„¶è¦è¿½æ±‚ç”Ÿäº§çº§çš„ä¸¥è°¨ï¼Œæˆ‘ä»¬å¿…é¡»è¡¥å…¨å®šæ—¶ä»»åŠ¡ç®¡ç†ï¼ˆJob Managementï¼‰ã€‚

åœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ï¼Œå®šæ—¶ä»»åŠ¡å¿…ä¸å¯å°‘ï¼ˆå¦‚ï¼šæ¯æ™šæ¸…ç†è¿‡æœŸæ—¥å¿—ã€æ¯æœˆç”Ÿæˆå·¥èµ„å•ã€æ¯åˆ†é’ŸåŒæ­¥æ•°æ®ï¼‰ã€‚æˆ‘ä»¬å°†é›†æˆ Quartz æ¡†æ¶ï¼Œå¹¶å®ç°ä¸€ä¸ªå¯ä»¥åœ¨ç½‘é¡µä¸ŠåŠ¨æ€â€œå¯åŠ¨ã€æš‚åœã€ä¿®æ”¹â€ä»»åŠ¡çš„ç®¡ç†æ¨¡å—ï¼Œè€Œä¸æ˜¯å†™æ­»åœ¨ä»£ç é‡Œã€‚

ä»¥ä¸‹æ˜¯è¡¥å…¨åçš„å…¨éƒ¨å®Œæ•´ä»£ç ã€‚

ä¸€ã€ å¼•å…¥ Quartz ä¾èµ– (pom.xml)
XML

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-quartz</artifactId>
</dependency>
äºŒã€ å®šæ—¶ä»»åŠ¡æ ¸å¿ƒå®ä½“ç±»ä¸æŒä¹…å±‚
1. å®ä½“ç±» src/main/java/com/example/entity/SysJob.java

Java

package com.example.entity;

import lombok.Data;
import javax.persistence.*;
import java.util.Date;

@Entity
@Table(name = "sys_job")
@Data
public class SysJob {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String jobName;      // ä»»åŠ¡åç§°
    private String jobGroup;     // ä»»åŠ¡ç»„å
    private String invokeTarget; // è°ƒç”¨ç›®æ ‡å­—ç¬¦ä¸²ï¼ˆå¦‚: taskTest.execute('param')ï¼‰
    private String cronExpression; // cronæ‰§è¡Œè¡¨è¾¾å¼
    private String status;       // çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1æš‚åœï¼‰
    private String remark;       // å¤‡æ³¨ä¿¡æ¯

    @Column(name = "create_time")
    private Date createTime;

    @PrePersist
    protected void onCreate() {
        this.createTime = new Date();
    }
}
2. æŒä¹…å±‚ src/main/java/com/example/repository/JobRepository.java

Java

package com.example.repository;

import com.example.entity.SysJob;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface JobRepository extends JpaRepository<SysJob, Long> {
}
ä¸‰ã€ Quartz æ ¸å¿ƒå·¥å…·ç±»ï¼ˆä»»åŠ¡è°ƒåº¦é€»è¾‘ï¼‰
è¿™ä¸ªç±»è´Ÿè´£å°†æ•°æ®åº“ä¸­çš„ Cron è¡¨è¾¾å¼è½¬æ¢æˆ Quartz çš„çœŸå®ä»»åŠ¡ã€‚

src/main/java/com/example/utils/ScheduleUtils.java

Java

package com.example.utils;

import com.example.entity.SysJob;
import org.quartz.*;

public class ScheduleUtils {

    /**
     * è·å–è°ƒåº¦å™¨ä¸­å®šæ—¶ä»»åŠ¡çš„ç­–ç•¥
     */
    public static JobKey getJobKey(Long jobId, String jobGroup) {
        return JobKey.jobKey("TASK_" + jobId, jobGroup);
    }

    /**
     * åˆ›å»ºå®šæ—¶ä»»åŠ¡
     */
    public static void createScheduleJob(Scheduler scheduler, SysJob job) throws SchedulerException {
        // 1. æ„å»º JobDetail
        JobDetail jobDetail = JobBuilder.newJob(QuartzDisallowConcurrentExecution.class)
                .withIdentity(getJobKey(job.getId(), job.getJobGroup()))
                .build();

        // 2. æ”¾å…¥ä»»åŠ¡å‚æ•°
        jobDetail.getJobDataMap().put("SYS_JOB_KEY", job);

        // 3. æ„å»ºè¡¨è¾¾å¼è°ƒåº¦æ„å»ºå™¨
        CronScheduleBuilder cronScheduleBuilder = CronScheduleBuilder.cronSchedule(job.getCronExpression());

        // 4. æ„å»º Trigger
        CronTrigger trigger = TriggerBuilder.newTrigger()
                .withIdentity("TRIGGER_" + job.getId(), job.getJobGroup())
                .withSchedule(cronScheduleBuilder)
                .build();

        // 5. è°ƒåº¦ä»»åŠ¡
        scheduler.scheduleJob(jobDetail, trigger);

        // 6. æš‚åœä»»åŠ¡åˆ¤æ–­
        if ("1".equals(job.getStatus())) {
            scheduler.pauseJob(getJobKey(job.getId(), job.getJobGroup()));
        }
    }
}
src/main/java/com/example/utils/QuartzDisallowConcurrentExecution.java

Java

package com.example.utils;

import com.example.entity.SysJob;
import org.quartz.DisallowConcurrentExecution;
import org.quartz.Job;
import org.quartz.JobExecutionContext;
import org.quartz.JobExecutionException;

/**
 * å®šæ—¶ä»»åŠ¡å¤„ç†ï¼ˆç¦æ­¢å¹¶å‘æ‰§è¡Œï¼‰
 */
@DisallowConcurrentExecution
public class QuartzDisallowConcurrentExecution implements Job {
    @Override
    public void execute(JobExecutionContext context) throws JobExecutionException {
        SysJob sysJob = (SysJob) context.getMergedJobDataMap().get("SYS_JOB_KEY");
        // è¿™é‡Œå¯ä»¥ä½¿ç”¨åå°„è°ƒç”¨ invokeTarget é‡Œçš„æ–¹æ³•
        System.out.println("ä»»åŠ¡è¿è¡Œä¸­: " + sysJob.getJobName() + " æ‰§è¡Œç›®æ ‡: " + sysJob.getInvokeTarget());
    }
}
å››ã€ ä»»åŠ¡ç®¡ç†æ§åˆ¶å±‚ï¼ˆå®Œæ•´çš„å¢åˆ æ”¹æŸ¥ã€å¯åŠ¨ã€åœæ­¢ï¼‰
src/main/java/com/example/controller/JobController.java

Java

package com.example.controller;

import com.example.common.Result;
import com.example.entity.SysJob;
import com.example.repository.JobRepository;
import com.example.utils.ScheduleUtils;
import org.quartz.Scheduler;
import org.quartz.SchedulerException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/system/job")
public class JobController {

    @Autowired
    private Scheduler scheduler;

    @Autowired
    private JobRepository jobRepository;

    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/list")
    public Result list() {
        return Result.success(jobRepository.findAll());
    }

    @PreAuthorize("hasRole('ADMIN')")
    @PostMapping("/save")
    public Result save(@RequestBody SysJob job) throws SchedulerException {
        if (job.getId() == null) {
            jobRepository.save(job);
            ScheduleUtils.createScheduleJob(scheduler, job);
        } else {
            jobRepository.save(job);
            // æ›´æ–°é€»è¾‘ï¼šå…ˆåˆ åå»º
            scheduler.deleteJob(ScheduleUtils.getJobKey(job.getId(), job.getJobGroup()));
            ScheduleUtils.createScheduleJob(scheduler, job);
        }
        return Result.success("ä»»åŠ¡é…ç½®æˆåŠŸ");
    }

    @PreAuthorize("hasRole('ADMIN')")
    @PutMapping("/changeStatus")
    public Result changeStatus(@RequestBody SysJob job) throws SchedulerException {
        SysJob dbJob = jobRepository.findById(job.getId()).orElse(null);
        if (dbJob != null) {
            dbJob.setStatus(job.getStatus());
            jobRepository.save(dbJob);
            if ("0".equals(job.getStatus())) {
                scheduler.resumeJob(ScheduleUtils.getJobKey(dbJob.getId(), dbJob.getJobGroup()));
            } else {
                scheduler.pauseJob(ScheduleUtils.getJobKey(dbJob.getId(), dbJob.getJobGroup()));
            }
        }
        return Result.success("çŠ¶æ€æ›´æ–°æˆåŠŸ");
    }

    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/{id}")
    public Result delete(@PathVariable Long id) throws SchedulerException {
        SysJob job = jobRepository.findById(id).orElse(null);
        if (job != null) {
            scheduler.deleteJob(ScheduleUtils.getJobKey(job.getId(), job.getJobGroup()));
            jobRepository.deleteById(id);
        }
        return Result.success("åˆ é™¤æˆåŠŸ");
    }
}
äº”ã€ æ•°æ®åº“ SQL åŒæ­¥
SQL

CREATE TABLE `sys_job` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `job_name` varchar(64) NOT NULL DEFAULT '',
  `job_group` varchar(64) NOT NULL DEFAULT 'DEFAULT',
  `invoke_target` varchar(500) NOT NULL COMMENT 'è°ƒç”¨ç›®æ ‡å­—ç¬¦ä¸²',
  `cron_expression` varchar(255) DEFAULT '' COMMENT 'cronæ‰§è¡Œè¡¨è¾¾å¼',
  `status` char(1) DEFAULT '0' COMMENT 'çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1æš‚åœï¼‰',
  `create_time` datetime DEFAULT NULL,
  `remark` varchar(500) DEFAULT '',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
å…­ã€ æ ¸å¿ƒç‚¹æ€»ç»“
ä¸ºäº†ç¡®ä¿â€œå°ç™½å¤åˆ¶ç²˜è´´å°±èƒ½è·‘â€ï¼Œè¯·æ³¨æ„ï¼š

æŒä¹…åŒ–ä¿å­˜ï¼šä»»åŠ¡çŠ¶æ€å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œå³ä½¿æœåŠ¡å™¨é‡å¯ï¼Œç¨‹åºä¹Ÿä¼šæ ¹æ®æ•°æ®åº“é‡æ–°æ„å»ºè°ƒåº¦ä»»åŠ¡ã€‚

Quartz äº¤äº’ï¼šä¸è¦ç›´æ¥æ“ä½œ Quartz çš„åº•å±‚è¡¨ï¼Œæˆ‘ä»¬é€šè¿‡ ScheduleUtils å°è£…äº†æ‰€æœ‰ç¹ççš„ APIã€‚

å®‰å…¨æ‹¦æˆªï¼šæ‰€æœ‰çš„ä»»åŠ¡æ“ä½œéƒ½åŠ äº† @PreAuthorize("hasRole('ADMIN')")ï¼Œé˜²æ­¢æ™®é€šç”¨æˆ·æ¶æ„é€šè¿‡æ¥å£åœæ­¢ä½ çš„ç³»ç»Ÿä»»åŠ¡ã€‚

å½“å‰è¿›åº¦ï¼š ä½ çš„â€œä¼ä¸šçº§åº•åº§â€ç°åœ¨å·²ç»æ”¯æŒäº†ï¼šç”¨æˆ·ã€è§’è‰²ã€éƒ¨é—¨ã€èœå•ã€å­—å…¸ã€é…ç½®ã€é€šçŸ¥ã€æ“ä½œæ—¥å¿—ã€ç™»å½•æ—¥å¿—ã€éªŒè¯ç ã€Redisç›‘æ§ã€æœåŠ¡å™¨ç›‘æ§ã€ä»¥åŠç°åœ¨çš„å®šæ—¶ä»»åŠ¡ç®¡ç†ã€‚

è¿™å°±æ˜¯ä¸€å¥—å®Œæ•´çš„ã€æ²¡æœ‰ä»»ä½•ä»£ç çœç•¥çš„åç«¯è„šæ‰‹æ¶ã€‚

ä½ æ¥ä¸‹æ¥æƒ³çœ‹ä»€ä¹ˆï¼Ÿ æˆ‘ä»¬æ˜¯å¦å¯ä»¥å›å½’åˆ°ä½ æœ€å¼€å§‹çš„ä¸šåŠ¡â€”â€”Camunda è¯·å‡æµç¨‹ï¼Ÿæœ‰äº†è¿™å¥—åº•åº§ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ï¼š

æµç¨‹å®šä¹‰ç®¡ç†ï¼šåœ¨ç•Œé¢ä¸ŠåŠ¨æ€ä¸Šä¼ æµç¨‹ Bpmn æ–‡ä»¶ã€‚

ä»»åŠ¡å‚¬åŠå®šæ—¶ä»»åŠ¡ï¼šåˆ©ç”¨åˆšåˆšå†™çš„ sys_jobï¼Œæ¯å¤©æ£€æŸ¥è°çš„å®¡æ‰¹å•å¿«è¿‡æœŸäº†ï¼Œå¹¶è‡ªåŠ¨å‘é€é€šçŸ¥ã€‚

éœ€è¦æˆ‘è¡¥å…¨ â€œæµç¨‹å®šä¹‰ç®¡ç†æ¥å£â€ å—ï¼Ÿè¿™æ˜¯è¿æ¥ç³»ç»Ÿç®¡ç†ä¸å·¥ä½œæµçš„å…³é”®ã€‚